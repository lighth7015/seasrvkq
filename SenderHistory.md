<h1>Сендер и его история</h1>
<p>На этой странице вы можете узнать о том, что такое "сендер", какие версии<br>
и варианты программ этого семейства бывали в общежитии, а также то, как им<br>
пользоваться, и почему в общежитии пользуются именно такой программой, а не<br>
каким-нибудь <a href='#whynotchat'>чатом</a>. Не стоит пугаться скроллбара :-)<br>
просто на этой странице много картинок. А еще здесь, кроме самой истории, есть<br>
выводы и анализ причин успехов и неудач программных проектов. Если кто-нибудь<br>
из читателей собирается работать в IT-индустрии и поддерживать свой продукт,<br>
эти примеры могут оказаться весьма полезны, а иногда и послужить поучительным<br>
уроком...</p>
<table width='100%'><tr><td width='30%'>&nbsp;</td><td><i><div>
&laquo;Те, кто не помнит прошлого, обречены повторять его снова и снова&raquo;<br>
<br><b>Джордж Сантаяна</b>

Unknown end tag for </div>

<br>
<br>
Unknown end tag for </i><br>
<br>
<br>
<br>
Unknown end tag for </td><br>
<br>
<br>
<br>
Unknown end tag for </tr><br>
<br>
<br>
<br>
Unknown end tag for </table><br>
<br>
<br>
<br>
<h2>Краткое оглавление (для тех, кому лень читать целиком)</h2>
<a></a>
<p><a href='#birth'>Рождение</a></p>
<p><a href='#tcps098'>TCPSender 0.9.8</a></p>
<p><a href='#tcpsint'>Устройство TCPSender 0.9.8 и другие его возможности</a></p>
<p><a href='#tcpsbugs'>Проблемы TCPSender 0.9.8 и его дальнейшая история</a></p>
<p><a href='#whynotchat'>Лирическое отступление: почему сендер, а не чат?</a></p>
<p><a href='#spsender'>SPSender</a></p>
<p><a href='#seahist'>SEA Sender: интриги и политика</a></p>
<p><a href='#seautumn'>Осеннее обострение</a></p>
<p><a href='#seavtfnet'>Холодная война и железный занавес</a></p>
<p><a href='#seahack'>Почти детективная история</a></p>
<p><a href='#seasunset'>Времена упадка и запустения</a></p>
<p><a href='#seabugs'>Галерея скриншотов багов SEA Sender</a></p>
<p><a href='#blastcore'>Настоящее время</a></p>
<p><a href='#seashit'>Недостатки SEA Sender с точки зрения программиста</a></p>
<p><a href='#javashit'>Проблемы реализации</a></p>
<p><a href='#seafixes'>Возможные улучшения</a></p>
<p><a href='#thsender'>Каким могло бы быть будущее</a></p>
<p><a href='#thsender'>TheSender</a></p>
<p><a href='#kpot'>Предложение Крота</a></p><a><h2>Рождение</h2></a>
<p>Вскоре после зарождения сети пользователям потребовалось средство для<br>
общения. Ведь бегать из комнаты в комнату для того, чтобы что-то<br>
сказать, неудобно, почему бы не сделать это средствами самой сети? Возникает<br>
лишь вопрос, каким средством. Естественно, что прежде всего были использованы<br>
программы, входящие в состав ОС, стандартная "Служба сообщений" Windows. На<br>
Windows NT (а также на появившихся спустя годы Windows 2000 и Windows XP) это<br>
была утилита командной строки <tt>net send</tt>, а на Windows 95 и 98 &mdash;<br>
утилита WinPopup.</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/winpopup.gif' />"<br>
width="640" height="480" align="center" alt="" title=""></a>
<p>WinPopup, как можно видеть по скриншоту, умел немного &mdash; всего-то<br>
отправить сообщение на компьютер или рабочую группу, сыграть звук по приходу<br>
сообщения, да пролистать/удалить то, что пришло. Максимальный размер сообщения<br>
был невелик, и имена получателей приходилось каждый раз набирать вручную. Одним<br>
словом, неудобно. Совсем неудобно.</p>
<p>Промучившись так первое время, первый админ сети, Александр Александр<i>о</i>в,<br>
принимает решение писать свою замену WinPopup, позже названную TCPSender.<br>
Сейчас это может показаться странным, когда существует большое количество<br>
разнообразных программ для общения. Но какие тогда были альтернативы? На дворе<br>
был 1997 год, локалка общежития АВТФ &mdash; одна из первых по стране, то, что позже<br>
назовут "домашними сетями", еще только зарождалось. Единственным вариантом мог<br>
быть лишь <br>
<br>
<acronym title="Internet Relay Chat"><br>
<br>
IRC<br>
<br>
</acronym><br>
<br>
, но в те годы и<br>
он еще лишь адаптировался к российским условиям (существующая и поныне IRC-сеть<br>
<a href='http://www.rus-net.org/'>RusNet</a> родилась примерно в то же время).<br>
Кроме того, IRC построен на клиент-серверной архитектуре, а в то время доступ<br>
в Интернет у общаги был не всегда, да и создавать единую точку отказа в виде<br>
сервера никто не хотел.</p>
<p>Итак, Александров пишет TCPSender. Первоначально программа отличалась от<br>
WinPopup не очень значительно, но уже имела список пользователей справа, где<br>
было видно, кто сейчас есть в онлайне, и можно было послать пользователю<br>
сообщение, просто щелкнув по нему. Сразу после Нового 1998 Года программа<br>
достигает версии 0.9.2:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-main-092.png' />"<br>
width="389" height="308" align="center" alt="TCPSender 0.9.2" title=""></a>
<p>В обиходе программу стали называть просто "сендер", в разговорах жителей<br>
общаги часто стало можно слышать "я тебе в сендер напишу", "какой у тебя ник в<br>
сендере?", "позвони мне в сендер как придешь", и т.д.</p>
<p>В конце января 1998 года выходит версия 0.9.7, а затем &mdash; 0.9.8 beta,<br>
которая осталась в использовании на много лет. Рассмотрим её поподробнее.</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h2>TCPSender 0.9.8 beta: что он умел и как им пользоваться</h2></a>
<table align='right' border='0'><tr valign='top'><td width='352' height='223'>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-about.png' />"<br>
width="352" height="223" align="right" hspace="5" vspace="1"<br>
alt="TCPSender 0.9.8 beta - О программе"></a></td></tr>
<tr><td><p>TCPSender 0.9.8 beta &mdash; окно "О программе"</p>
</td></tr></table>
<p>Главное окно имело панель с кнопками, выпадающий список принятых сообщений,<br>
поле отображения текста сообщения, и список пользователей. Пользователи<br>
именовались в формате "Имя пользователя[Имя<i>компьютера]", причем оба имени<br>
брались из системных настроек Windows &mdash; т.е. совпадали с тем, что видно в<br>
"Сетевом окружении".</p></i><p>Двойным щелчком по имени пользователя в списке (или выбором в контекстном<br>
меню) можно было открыть окно отправки ему сообщения. Иконки показывали, в<br>
онлайне пользователь сейчас, или же его машина выключена (показ оффлайновых<br>
можно было и скрыть в настройках).</p>
<p>Можно было и нажать кнопку "Ответить" &mdash; в таком случае, текст текущего<br>
сообщение <i>цитировался</i> в окне редактирования сообщения по принципам,<br>
аналогичным в FidoNet/e-mail: каждая строчка оригинала снабжалась символом<br>
"<b><tt>&gt;</tt></b>", перед которым приписывалось имя пользователя,<br>
написавшего этот текст. Таким образом, среди кучи сообщений становилось<br>
возможным различать, кто на что отвечал, а в случае личной переписки с большим<br>
временн<i>ы</i>м интервалом &mdash; и вспомнить, о чем шла речь.</p>
<table border='0'><tr valign='top'><td width='800' height='600'>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-main.jpg' />"<br>
width="800" height="600" align="center" hspace="5" vspace="1" alt="TCPSender<br>
0.9.8 beta - главное окно и окно отправки" title=""></a></td></tr>
<tr><td><p>TCPSender 0.9.8 beta &mdash; главное окно и окно отправки<br>
сообщения</p>
</td></tr></table>
<p>Сообщения можно было перелистывать кнопками со стрелками на панели (или<br>
нажимать Ctrl+стрелки на клавиатуре) либо выбрать напрямую в выпадающем<br>
списке, где писалось, кто автор, кому предназначено, время написания, а также<br>
иконка слева показывала, было ли это сообщение приватным (личным) или же для<br>
всей группы:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-main-cbox.png' />"<br>
width="453" height="360" align="center" alt="" title=""></a>
<p>Кроме того, кнопки-стрелки на панели инструментов и кнопка удаления понимали<br>
щелчок правой кнопкой мыши, показывая меню, в котором можно было переместиться<br>
в начало или конец списка, а также удалить сразу много сообщений:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-main-delpopup.png' />"<br>
width="367" height="147" align="center" alt="" title=""></a>
<p>Если нужно было написать сообщение, можно было нажать кнопку нового (самая<br>
левая на панели) или дважды щелкнуть пользователя в списке, тогда открывалось<br>
окно отправки сообщения. В нём тоже имелся выпадающий список, но уже с<br>
пользователями и группами &mdash; например, в случае "писал-писал одному в приват и<br>
вдруг решил отправить всем" можно было открыть список и выбрать другого:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-send-cbox.png' />"<br>
width="362" height="269" align="center" alt="" title=""></a>
<p>Частенько компьютеры не выключаются на ночь, а есть, например, потребность<br>
периодически отсылать объявления &mdash; для тех, кто еще не видел. В таком разе<br>
заново набирать сообщение как-то лениво. Поэтому сендер имеет окно с перечнем<br>
всех ранее отосланных сообщений, можно выбрать и отослать заново (отредактировав<br>
при необходимости):</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-sentmsgs.png' />"<br>
width="670" height="536" align="center" alt="" title=""></a>
<p>Если в настройках сендера стояла соответствующая галка, то при каждой<br>
отправке сообщения выскакивало окно, которое показывало, действительно ли<br>
сообщение доставлено получателям &mdash; и кому из них. Впрочем, если сообщение было<br>
кому-то доставлено, это еще не значит, что оно до него дошло :-)</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-delivered.png' />"<br>
width="373" height="344" align="center" alt="" title=""></a>
<p>Конечно, сообщения удобны, если Вы задаете вопрос всей общаге сразу &mdash; кто-то<br>
ответит раньше, кто-то позже... Но что, если внимание собеседника нужно привлечь<br>
немедленно? В этом случае поможет режим чата: на нужном пользователе в списке<br>
ткнуть правой кнопкой и выбрать Chat &mdash; тогда на машине собеседника раздастся<br>
звук звонка телефона и появится окно, позволяющее принять "звонок" или же<br>
сбросить. Или ничего не делать (потому что Вас нет у компа, например), тогда<br>
вызывающий сам устанет и отменит &mdash; а у вызываемого в списке сообщений<br>
появится, что у вас, мол, был звонок от того-то, Вы не ответили, он повесил<br>
трубку и это печально. В противном же случае открывалось окно чата на двоих.<br>
Оно содержало кнопку, при нажатии которой на том конце снова раздавался звук<br>
звонка &mdash; на случай, если собеседник вдруг заснул и не отвечает :-)</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-chat.jpg' />"<br>
width="800" height="600" align="center" alt="" title=""></a>
<p>Осталось добавить только, что к программе настолько привыкли, что она<br>
стала частью традиций, можно сказать, духа общаги АВТФ. Вот как описывает его<br>
один из старых студентов:</p>
<blockquote>
<p>Своё первое &laquo;знакомство&raquo; с сендером я вспоминаю примерно<br>
так:</p>
<p>Учиться мы приехали сразу на второй курс. Зелёные, одомашненные,<br>
практически абитура! При попадании в новую языковую среду, наверно больше<br>
половины слов не понимались вообще. Меня и моего однокашника поселили вместе<br>
с Акой &mdash; легендарным КС-снайпером общаги АВТФ в то время.</p>
<p>Ака на первых порах и был нашим путеводителем по всему неизведанному. По<br>
тем временам компьютер не был той заурядностью, какой он является сейчас и в<br>
комнате он был только у Тимура (aka). Нужно отметить, что Тимур не был жмотом<br>
и давал пользоваться его компьютером, если конечно это не было время<br>
кланвара.</p>
<p>&laquo;Что это такое?&raquo; &mdash; полюбопытствовал я, когда впервые увидел<br>
яркий значок неподалёку от системного времени. &laquo;Сендер!&raquo; &mdash;<br>
буркнул Тимур, будто это не было чем-то необычным, и продолжил планировать<br>
атаку на вечер.</p>
<p>Ещё некоторое время TCPSender так и пробыл некоторой тайной, но в скором<br>
времени влился и в нашу студенческую повседневность и мы уже не представляли<br>
потом, как же без него жили раньше =)</p>
</blockquote>
<p>С ним даже были связаны некоторые специфичные традиции, типа вечернего<br>
счета (кто пишет на группу "1", другой на группу отвечает "2", и считают, пока<br>
кто-нибудь не пожалуется на флуд). Впрочем, об этом лучше слушать из уст<br>
старожилов, чем читать...</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h3>Устройство TCPSender 0.9.8 и другие его возможности</h3></a>
<table align='right' border='0'><tr valign='top'><td width='367' height='147'>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-main-viewmenu.png' />"<br>
width="367" height="147" align="center" hspace="5" vspace="1" alt="" title=""><br>
</a></td></tr><tr><td><p>TCPSender 0.9.8 beta &mdash; другие фичи</p>
</td></tr></table>
<p>Устроен TCPSender 0.9.8 был так: никакого сервера, каждая копия на каждой<br>
машине открывает TCP-порт и слушает запросы на соединение. При этом на каждой<br>
же машине каждая копия периодически сканирует заданный в настройках диапазон<br>
IP-адресов. Ответили &mdash; значит, там пользователь жив. Не ответили &mdash; помечаем его<br>
в списке как оффлайн. Отправка сообщений группе производилась точно таким же<br>
образом &mdash; просто перебирались все в списке, но на этот раз быстро; получилось<br>
соединиться &mdash; сообщение доставлено.</p>
<p>Данный подход имеет как плюсы, так и минусы. Плюсы заключались в том, что<br>
для работы сендеров не требуется выделенный сервер &mdash; и если этот сервер вдруг<br>
завис или просто становится недоступен, связь друг с другом не теряется. Такая<br>
возможность &mdash; одна из целей при создании самого Интернета, между прочим. А<br>
кроме того, каждый пользователь может самостоятельно настроить у себя сколько<br>
угодно разных <i>групп</i>. Для управления ими был интерфейс, вызывавшийся<br>
кнопкой с несколькими человечками на панели инструментов:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-grpmgr.gif' />"<br>
width="418" height="250" align="center" alt="" title=""></a>
<p>Можно было и посмотреть, кто и в каких группах сейчас в онлайне:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-grptree.png' />"<br>
width="417" height="373" align="center" alt="" title=""></a>
<p>Для автоматического заполнения групп по сканированию диапазонов IP-адресов<br>
нужно было указать в окне настроек на вкладке сканпулов начальный адрес и<br>
число адресов в диапазоне:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-scanpool.jpg' />"<br>
width="389" height="422" align="center" alt="" title=""></a>
<p>Но имела эта автономность и свои минусы. Прежде всего, минусом оборачивался<br>
плюс независимой настройки групп &mdash; если у разных пользователей для группы "АВТФ"<br>
были в списке разные машины, при ответе на группу его могли получить, например,<br>
не все. С этим, впрочем, легко можно было справиться, покуда дело касалось<br>
внутриобщажных пользователей (с городскими сложнее). Иногда приходилось из<br>
списка некоторых пользователей вычищать вручную (например, на этом адресе уже<br>
нет сендера):<br>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-removeusers.png' />"<br>
width="418" height="177" align="center" alt="" title=""></a>
<p>Но TCPSender 0.9.8 beta имел и свои глюки :-) Например, собственная машина<br>
могла попасть в список несколько раз, под разными адресами. Тогда при отправке<br>
сообщения на группу Вы получали своё же сообщение в нескольких дубликатах. Для<br>
борьбы с этим багом задействовали удаление одного из них, вот так:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-removedaddrs.png' />"<br>
width="276" height="178" align="center" alt="" title=""></a>
<p>С этим подходом были и другие проблемы, но рассмотрим их позже, а<br>
пока &mdash; осталось показать еще несколько скриншотов TCPSender 0.9.8 beta. Так,<br>
у него была возможность auto-away: если Вы ничего не делали 10 (по умолчанию)<br>
минут, он переходит в этот режим, и на любое входящее сообщение сработает<br>
автоответчик с заданным текстом:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-away.png' />"<br>
width="386" height="422" align="center" alt="" title=""></a>
<p>В меню можно было выбрать и "ручной" away, с текстом специально для данного<br>
случая. Впрочем, работал он только для автоответчика &mdash; снаружи можно было лишь<br>
посмотреть информацию о пользователе, каков его Status &mdash; online, away, autoaway...</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-userinfo.png' />"<br>
width="306" height="206" align="center" alt="" title=""></a>
<p>Другие вкладки окна опций (картинки откроются в новом окне):</p>
<table cellpadding='15' border='1' cellspacing='5'><tr valign='top'>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-chat.png' />"><img<br>
src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-chat.png' />" width="193" height="211"<br>
align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Можно <s>грабить корованы</s> задавать звук и шрифт окну чата</p>
</td>
<td>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-general.jpg' />"><img<br>
src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-general.jpg' />" width="193" height="211"<br>
align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Вкладка с основными настройками</p>
</td>
<td>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-mail.png' />"><img<br>
src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-opts-mail.png' />" width="193" height="211"<br>
align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Автору были нужны уведомления о почте &mdash; и он их тоже приделал</p>
</td></tr></table>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h3>Проблемы TCPSender 0.9.8 и его дальнейшая история</h3></a>
<p>TCPSender 0.9.8 beta вышел в 1998 году и так навсегда и остался бетой. Тому<br>
виной много причин. Прежде всего, Александров окончил учебу и передал "бразды<br>
правления" следующему админу. Исходники сендера остались на жестком диске<br>
первого общажного сервера... который спустя некоторое время погиб (диск, а не<br>
сервер). И исходники вместе с ним. И так эта версия и осталась в использовании<br>
надолго, тем более, что она в принципе устраивала всех. Тому подтверждением<br>
может служить, что спустя лет 6 копии исходников обнаружились у аспирантов и<br>
прочих оставшихся жить в общаге старшекурсников &mdash; но к этому моменту уже было<br>
ясно, что писать его надо с нуля.</p>
<p>На это опять же было несколько причин. Во-первых, он был глючен, мог падать<br>
и всякие фокусы выкидывать, зачастую обусловленные проблемами старой версии<br>
Delphi, на которой он был написан. Причем с использованием таких компонентов,<br>
что в более новых он уже не собирался (и попытки поправить были бы нетривиальны<br>
ввиду имен вида TForm1..TForm14, и так везде). Но часть из них была терпима,<br>
часть давно научились обходить верной расстановкой галочек в настройках.</p>
<p>Во-вторых, и это гораздо более серьезно &mdash; сканирование сети, как сейчас<br>
говорят, плохо масштабировалось с ростом размера сети. В норме пробовался один<br>
IP-адрес раз в 5 секунд. В результате полный цикл проверки онлайна всей сети<br>
из 256 адресов занимал более 20 минут &mdash; и всё это время Ваш собеседник мог<br>
считаться онлайн, в то время как он уже выключил свою машину. Попытки сделать<br>
это время меньше (до 2006 года сеть еще не достигла такого количества человек)<br>
путем указания поддиапазонов &mdash; вызывали необходимость всем переконфигурировать<br>
сендер, когда подключались новые люди к сети. Кроме того, сохранение списка<br>
машин в сети в реестре было реализовано глючно &mdash; в нем надолго могли оставаться<br>
люди, которые уже съехали с общаги. А периодическая чистка и заполнение с нуля<br>
часто наталкивалось уже на следующую, третью проблему.</p>
<p>В-третьих, сканирование было реализовано так, что сендер прямо в данных<br>
пакета сообщал той стороне свой IP-адрес в текстовом виде, и она использовала<br>
именно его. Всё бы ничего, но это приводило к проблемам, если был неверно<br>
определен адрес своим сендером (например, создала вам VMWare виртуальную сеть<br>
для виртуальной машины с фейковым адресом, а сендер посчитал основным именно<br>
его), или в случае NAT. NAT, или "Общий доступ к соединению" на Windows,<br>
выпускал в сеть через себя другой компьютер (через соединение с ним второй<br>
сетевой картой). При этом такому компьютеру назначается "серый" приватный адрес<br>
192.168.0.2 (обычно именно такой), видный только в этой внутренней сети. Если<br>
на нём стоял сендер, то он, естественно, знал и сообщал только этот адрес. В<br>
результате пользователь появлялся у других сендреов в списке, когда он сам их<br>
сканировал, он мог отправлять им сообщений &mdash; но ответить ему было невозможно,<br>
ибо нельзя соединиться с таким адресом снаружи. В общаге это не представляло<br>
проблемы, поскольку такие внутренние сети существовали в пределах комнаты (а<br>
позже их вообще запретили), и можно было обойтись одним сендером на комнату.<br>
Но у городских NAT часто делал провайдер, и тут уже ничего сделать было<br>
нельзя.</p>
<p>Стало ясным, что необходим клиент-серверный вариант. Но TCPSender 0.9.8 beta<br>
успешно пережил первую попытку в 2005 и сдал свои позиции только после второй<br>
попытки в 2006 году. И то постепенно &mdash; лишь в 2007 году он умер окончательно,<br>
оставшись только у нескольких единиц человек из старожилов. Подробнее об этом &mdash;<br>
в следующих разделах.</p>
<a><h2>Лирическое отступление: почему сендер, а не чат?</h2></a>
<p>Несмотря на все недостатки TCPSender 0.9.8, как баги, так и неудобства, им<br>
в неизменном виде продолжали пользоваться многие годы. Ситуация тем более<br>
интересна, что разнообразные программы для общения в локальной сети &mdash; чаты &mdash; к<br>
тому времени уже появились, и даже в значительном количестве. Более того, были<br>
и попытки ввести их в общаге &mdash; в составе нашей сети долгое время была сеть<br>
общаги МСФ, и они, внутри своего сегмента, пользовались как раз такими чатами.<br>
Однако следует обратить внимание, что их было гораздо меньше, чем на АВТФ, 40<br>
человек, против полутора сотен (в те годы); в сендере максимальное число юзеров<br>
в онлайне достигало 120. Кроме того, МСФ периодически меняли программы, одно<br>
время у них был и известный VyPress Chat, потом они и от него отказались. АВТФ<br>
же всегда оставался на сендере.</p>
<p>Причина этого лежит в плохоосознаваемой, если специально не задумываться,<br>
разнице <i>концепций</i> сендера и чата. Каждый, кто хоть раз пользовался как<br>
чатом, так и форумом или электронной почтой (особенно списками рассылки), сразу<br>
поймет, что в них отличается <i>стиль</i> общения. Послушаем специалистов:</p>
<blockquote>
<p>Проблема нехватки паралингвистических средств характерна для всех форм<br>
сетевого общения, однако в чатах эта проблема максимально болезненна (не<br>
случайно компенсация смыслового ряда тела присутствует только в чатах), так<br>
как все это усугубляется тем, что общение происходит в режиме реального<br>
времени. У собеседников по сути отсутствует время на размышления над<br>
литературной формой своего высказывания. Максимально допустимая временная<br>
фора для ответа &mdash; 1-3 минуты, после этого смысла в ответе будет уже немного.<br>
Так как на экран одновременно выплескивается большое количество реплик, то<br>
через несколько минут послание, на которое вы отвечаете, будет безнадежно<br>
погребено под массой позднейших и о нем забудут все, в том числе и автор.</p>
<p>Из технических особенностей чата вытекает и еще одна особенность общения.<br>
Из-за того, что на экран одновременно поступает множество реплик, ограничение<br>
объема реплик является насущной необходимостью. Как правило, объем реплики в<br>
чате составляет в среднем три нераспространенных предложения. Именно по этой<br>
причине в чатах часто весьма затруднены глубокомысленные беседы, которые<br>
являются основным достоинством и недостатком другой глобальной формы сетевого<br>
общения &mdash; конференций.</p>
</blockquote>
<p>Однако стиль форумов, конференций, хоть и годится для более-менее постоянной<br>
переписки (которую можно перечитывать и спустя месяцы), всё же плохо подходит<br>
для внутреннего общения, где темы гораздо более быстротекущи. Остается чат?<br>
Но вспомним, что у чатов есть и другие проблемы:</p>
<blockquote>
<p>Все системы чата, включая IRC, однако, обладают общим фундаментальным<br>
<blockquote>свойством, исходящим из самой природы чата &mdash; предполагается очень<br>
быстрый обмен короткими фразами в течение продолжительного времени,<br>
что нередко не подходит &mdash; требуется послать не очень короткое<br>
сообщение (например "оставить записку"), причем лишь время от<br>
времени. Чат требует от пользователя реакции в реальном времени,<br>
не оставляя времени на долгие раздумья, вынуждая писать короткие<br>
(обычно однострочные) фразы, и практически мешает (во всяком случае,<br>
сделать нормой) писать длинные рассуждения или вставлять длинные<br>
цитаты текста. Это только усугубляется с ростом числа пользователей<br>
на одном канале &mdash; что, если разговор начнет вести одновременно<br>
большое число групп людей? В результате даже в крупных IRC-сетях<br>
количество человек на одном канале очень редко переваливает за сотню.</p>
</blockquote>
<p>Теперь вспомним количество человек на МСФ и АВТФ &mdash; действительно, уже другой<br>
размер. Что, если писать станут все 100 человек? За этой кашей станет трудно<br>
уследить, и уж точно это совершенно не нужно тому, кто ждёт только определенных<br>
сообщений.</p>
<blockquote>
<p>Во многих случаях подходящим решением является смена парадигмы &mdash;<br>
вместо чата использовать сообщения относительно большой длины<br>
(сравнительно с типичной длиной строк в чатах). Таким образом,<br>
общение теряет интерактивность, и пользователь получает возможность<br>
заниматься своим делом, не отвлекаясь на немедленный ответ (или даже<br>
просмотр) на пришедшие сообщения, если ему это не нужно. Отпадает<br>
необходимость быстрого ответа на сообщение, вместо этого оно может<br>
редактироваться сколь угодно долго (конечно, в разумных пределах).<br>
Соответственно, инициатива переходит к пользователю, самостоятельно<br>
планирующему свое время, от его собеседников, вольно или невольно<br>
принуждавших его к реагированию.</p>
</blockquote>
<p>Сендер, таким образом, получился разумным компромиссом между форумом и<br>
чатом, будучи нащупан совершенно случайно Александровым, когда тот делал<br>
замену WinPopup. К сожалению, эта разница в идеях не была осмыслена, и не<br>
была использована "на всю катушку". Так часто бывает: идея хороша, исполнение<br>
же "как всегда", и может её совершенно испортить. Представьте себе форум, в<br>
котором есть одно только текстовое поле ввода, и больше ничего, и современный<br>
форум, с его кучей смайликов, средств оформления и цитирования, вставки<br>
картинок... Разница в удобстве очевидна &mdash; но по сути своей и то и другое всё<br>
равно будет форумом, а не чем-то другим.</p>
<p>Увы, все реализации сендера и по сей день не обращают внимания на<br>
интерфейс, делая его по принципу "как проще программисту", минимально<br>
работает и ладно. Это частенько и отпугивает новых пользователей &mdash; сендер<br>
кажется чем-то старым и сходу непонятным, неудобным. Тогда как можно было бы,<br>
например, взять интерфейс типа современных клиентов ICQ &mdash; они тоже умеют<br>
многострочные сообщения (но ввиду ориентации на многомиллионную аудиторию,<br>
естественно, не делают их групповыми), скажем, <a href='#img-miranda-historypp'>вот<br>
так</a>. Многое можно было бы сделать, кое-что рассмотрено в <a<br>
href="#thsender">последнем разделе<br>
<br>
Unknown end tag for </a><br>
<br>
. Важно лишь, что идейная основа &mdash;<br>
будет не чатом.</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h2>SPSender</h2></a>
<p>В самом начале 2005 года (зимняя сессия еще только начиналась) Кирилл<br>
Каликин, аспирант, соорудил на базе исходников TCPSender бота-автоответчика &mdash;<br>
тот отвечал на сообщения вида "Кто печатает?" рекламой принтера в комнате 428.<br>
Желание заработать понятно, ведь в сессию печать в общаге весьма актуальна, но<br>
написал своего бота аспирант совсем по-студенчески &mdash; лишь бы как-то работало.<br>
В результате периодически бот отправлял криво сформированные пакеты, от чего у<br>
всей общаги разом сендеры вываливали окно об ошибке, и дальше оставалось<br>
возможным лишь прибить процесс. И так несколько дней подряд, пока его не<br>
вычислили. Каликин, конечно, за такую диверсионную деятельность (сессия, а тут<br>
связь отказывает) получил от админов (а заодно и за спам &mdash; реклама валилась<br>
всей общаге). Но этот случай показал, в дополнение к уже известным недостаткам<br>
TCPSender, что еще и с защитой от злонамеренных пользователей всё плохо.</p>
<p>Сейчас трудно сказать, подстегнул ли именно этот случай, но на зимних<br>
каникулах того же 2005 года Shaddix (Артур Дробинский), Pazalini (Артем<br>
Белоусов) и помогавший им Александр Подлесный &mdash; начали разработку нового<br>
сендера. Все трое &mdash; известные наши олимпиадники, разработка шла быстро &mdash; уже в<br>
конце февраля продукт умел не только базовый обмен сообщениями, но и скачивание<br>
обновлений самого себя по HTTP, смену языка интерфейса на ходу, поддержку<br>
away/autoaway. Разработка велась грамотно &mdash; с самого начала авторы сделали<br>
эскизный проект, куда сразу включили всё необходимое (например, поддержку чата<br>
и пересылки файлов).</p>
<p>Вот как он выглядел:</p>
<table cellpadding='15' border='0' cellspacing='5'><tr valign='top'><td>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/spsender-main.png' />"<br>
width="488" height="355" align="center" alt="" title=""></a>
<p>Стиль цитирования такой же; самая правая &mdash; кнопка Connect</p>
</td><td>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/spsender-about.png' />"<br>
width="306" height="323" align="center" alt="" title=""></a>
<p>Претенциозное было начинание...</p>
</td></tr><tr valign='top'><td>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/spsender-send.png' />"<br>
width="335" height="258" align="center" alt="" title=""></a>
<p>Кнопку очистки набранного приделать не успели</p>
</td><td>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/spsender-settings.png' />"<br>
width="304" height="302" align="center" alt="" title=""></a>
<p>В переводе с украинского на буржуйский, "нема" = "away"</p>
</td></tr></table>
<p>Серверная часть, которую написал Shaddix, представляла собой скрипт на языке<br>
Perl объемом 12 Кб (500 строк), в дальнейшем он намеревался сделать поддержку<br>
сохранения сообщений в базе, что добавило еще пару Кб. Всё шло хорошо, проект<br>
развивался быстро, вплоть до начала в мае сессии у 4 курса. Им пользовалось (в<br>
пиках) до 30 человек (четверть населения TCPSender).</p>
<p>Но... потом проект тихо угас.</p>
<p>Причин тому было две, хотя обе в итоге сводились к одним и тем же<br>
особенностям мышления большинства программистов. Первая &mdash; сервер периодически<br>
падал, по невыясненным причинам. Олимпиадный стиль программирования характерен<br>
написанием большого количества кода "на выброс" &mdash; ему требуется отработать лишь<br>
один раз. В проектах реальной жизни же напротив, нужна поддерживаемость кода,<br>
способность быстро искать и править ошибки, и сохранение этой способности в<br>
долгосрочной перспективе. Поэтому, хоть написан он был и быстро, некоторые баги<br>
попортили жизнь надолго.</p>
<p> Впрочем, это &mdash; не очень большая проблема, понимание приходит с опытом, а<br>
опыт &mdash; дело наживное, вопрос лишь времени. Исправимо. В сентябре Shaddix баг<br>
обнаружил, конечно, но решил заодно и сервер на Си переписать, тем самым еще<br>
раз частично "наступив на грабли" второй причины. Пользователей уже не было,<br>
и даже переписывание не было доведено до конца.</p>
<p>Вторая причина &mdash; это подход "этот код надо выкинуть и переписать всё с нуля,<br>
несовместимым со старым образом". <b>Никогда не поддавайтесь на соблазн сделать<br>
"с нуля" новую, несовместимую со старой систему</b>.</p>
<p>Конкретно в случае SPSender проблема выглядела так: пользователь ставил<br>
себе "новый" сендер, и обнаруживал, что людей в нём всего ничего, почти все,<br>
с кем нужно держать связь, сидят на "старом" (20 человек против 120). В<br>
результате он вынужден держать запущенными сразу оба, периодически наблюдая,<br>
что в новом все пропадают, а его авторы, видимо, не очень заинтересованы в<br>
исправлении проблем. В конечном итоге он не хочет возиться сразу с двумя и<br>
оставляет себе один &mdash; старый.</p>
<p>Точно такая же ситуация наблюдалась и, например, с ICQ &mdash; ею все пользуются,<br>
потому что все контакты там, а другими протоколами &mdash; только энтузиасты. Лишь<br>
когда одна программа начинает уметь сразу несколько сетей, причем удобно для<br>
пользователя &mdash; лишь тогда начались подвижки.</p>
<p>Но это не единственный пример, конечно. Поддавшись соблазну "переписать всё<br>
нафиг с нуля", провалились многие другие проекты. Была когда-то такая компания,<br>
Mozilla, делала одноименный браузер, лидер рынка, между прочим. И вот решили<br>
они, что код стал совсем неподдерживаемым, пора его выкинуть и переписать весь<br>
заново. Процесс растянулся на годы, за это время контора разорилась, а рынок<br>
браузеров захватил IE от Microsoft. Правда, они отдали код сообществу, из чего<br>
потом спустя годы вырос Firefox &mdash; но в те-то годы программисты остались без<br>
работы...</p>
<p>Кто-то может подумать, что это было давно. Увы, примеров таких много. Из<br>
последнего &mdash; громкий провал Google Wave. Они решили создать новую систему для<br>
общения, разрекламировали её. После чего люди обнаружили, что там нет никого из<br>
их существующих контактов, и нет возможности их добавить. Теперь системой<br>
пользуются только энтузиасты, и никакой шумихи уже нет (а то и поговаривают,<br>
что Google и вовсе прекратит этот проект).</p>
<p>Так произошло и здесь. SPSender хоть и был хорошим проектом, был прочно<br>
забыт после сентября 2005 года по, увы, совершенно не техническим причинам.</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h2>SEA Sender: интриги и политика</h2></a>
<p>Зимой 2006 года, в начале семестра, двоих студентов тогдашнего 4 курса (на<br>
курс младше авторов SPSender), Алексея Фадеева (#Kpot#, томич) и Сергея Хилкова<br>
(J7, председатель студсовета общежития) иногда можно было видеть на лекциях с<br>
увесистой книгой П.В. Румянцева "Азбука программирования в Win32 API" в руках<br>
(серьезное руководство, по довольно тяжелым низкоуровневым вещам). А когда<br>
стали таять снега, пользователи единственного на тот момент TCPSender'а стали<br>
время от времени наблюдать картину наподобие вот такой:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/tcpsender-seauser.png' />"<br>
width="653" height="527" align="center" alt="" title=""></a>
<p>Это выглядело как приписка чего-то совершенно нового, хотя, как видно, трюк<br>
достигнут впиской символов в имя компьютера. Но винда такие символы вписывать<br>
не разрешает, TCPSender тоже. Так, без предварительных публичных анонсов,<br>
заявил о себе новый проект, названный авторами SEA Sender (клиент был написан<br>
на MS Visual C++, сервер на Java). Они учли причину провала предшественников<br>
и предприняли значительные усилия для обеспечения совместимости: например,<br>
протокол TCPSender был получен анализом отправляемых им пакетов данных. Такую<br>
же технику применяют и для реверс-инжиниринга ICQ, поскольку официальные<br>
спецификации были закрыты (все, наверное, наслышаны о ситуациях "они обновили<br>
протокол и все неофициальные клиенты теперь не работают!").</p>
<p>Как работала совместимость с TCPSender? Очень просто &mdash; каждый клиент SEA<br>
открывал порты "старого" сендера и отвечал на сканирование, таким образом<br>
присутствуя в списках у старых, а также мог принимать от них сообщения. Сервер<br>
же производил сканирование сети на предмет "старых" сендеров, добавляя их в<br>
список у "новых", и осуществлял им рассылку групповых сообщений из "нового"<br>
сендера. Довольно просто (но, как оказалось позже, имело свои проблемы).</p>
<p>В апреле проект развернулся во всю, и первыми его оценили те страдальцы,<br>
которые сидели за NATами как в общаге, так и в городе &mdash; раньше они не могли<br>
воспользоваться сендером вообще (см. <a href='#tcpsbugs'>подраздел о проблемах<br>
TCPSender</a>).</p>
<p>Вот так выглядела одна из относительно поздних версий (скриншотов более<br>
ранних не сохранилось), вместе с окном информации о пользователе:</p>
<a></a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug07.png' />"<br>
width="588" height="433" align="center" alt="" title=""><br>
<p>Здесь пользователи SEA Sender отображены бирюзовым цветом, а пользователи<br>
TCPSender &mdash; сиреневым.</p>
<p>А вот так выглядели значки всех трех сендеров в системном трее:</p>
<table cellpadding='10' border='0' cellspacing='10'><tr valign='top'>
<td align='center'>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/senders-tray-empty.png' />"<br>
width="106" height="30" align="center" alt="" title=""></a>
<p>Слева направо: TCPSender, SEA Sender, SPSender</p>
</td><td align='center'>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/senders-tray-msgs.png' />"<br>
width="106" height="30" align="center" alt="" title=""></a>
<p>Они же, но в каждый пришло сообщение</p>
</td></tr></table>
<p>Одним из других, сразу бросавшихся в глаза отличий, было изменение в стиле<br>
цитирования сообщений при ответе. Если раньше TCPSender разбивал сообщение на<br>
строки по ширине окна и к каждой строке приписывал имя автора, то теперь такое<br>
приписывание делалось лишь вначале абзаца &mdash; а чтоб различать, где чей текст,<br>
ввели строку-разделитель:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug02.png' />"<br>
width="603" height="495" align="center" alt="" title=""></a>
<p>Никто не обратил внимания в то время на такую мелочь, как иконку одного<br>
"человечка" для приватов и нескольких &mdash; для группового сообщения. В TCPSender<br>
так можно было различать сообщения, теперь же приходилось вчитываться.</p>
<p>Кроме того, он гораздо более просто настраивался, чем TCPSender &mdash; достаточно<br>
было указать адрес основного сервера и запасного (на который соединялся, если<br>
не мог связаться с основным):</p>
<table cellpadding='10' border='0' cellspacing='5'><tr valign='top'>
<td>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seasender-opts-nick.jpg' />"<br>
width="347" height="235" align="center" alt="" title=""></a>
<p>Позволял изменить ник сразу, без переподсоединения</p>
</td><td>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seasender-opts-srv.jpg' />"<br>
width="347" height="236" align="center" alt="" title=""></a>
<p>А вот ввести DNS-имя сервера - не позволял...</p>
</td></tr></table>
<p>Однако развивался проект очень медленно. Тогда, весной 2006, он умел только<br>
обмениваться сообщениями. Показанная выше возможность изменения ника появилась<br>
лишь полгода спустя. Сначала не было возможности даже указать о себе какую-то<br>
информацию. Потом она появилась, но её формат был жестко зашит:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seasender-opts-info.jpg' />"<br>
width="299" height="195" align="center" alt="" title=""></a>
<p>Можно было только выбрать между двумя факультетами, АВТФ и МСФ, указать<br>
комнату, да до 256 символов информации. Городским оставалось только не писать<br>
комнату вовсе &mdash; и это при том, что сам автор был городской, и основной сервер<br>
работал на его машине!</p>
<p>Тем не менее, несмотря на низкую скорость развития, отсутствие поначалу даже<br>
чата, пользователи были довольны &mdash; для некоторых это была единственная<br>
возможность общаться, остальные же просто видели, что процесс идет, и, самое<br>
главное, могли в нем как-то поучаствовать. Здесь проявляется следующий фактор<br>
успешного проекта: <b>необходима обратная связь с пользователями и выполнение<br>
их пожеланий</b>. В сендере разворачивались обсуждения, что надо сделать, как<br>
сделать, предлагались варианты, выбирался какой-то один и реализовывался. И<br>
даже если ваш проект пока еще значительно хуже конкурентов, дайте пользователям<br>
ощутить, что они имеют влияние на разработчиков, и они будут счастливы, несмотря<br>
на все проблемы (тем более, что "конкурент" TCPSender был просто мертв, некому<br>
было развивать).</p>
<p>А проблемы были.</p>
<p>Да, на столь ранней фазе развития многие проблемы часто являются всего лишь<br>
"болезнями роста", и даже не очень прилично о них говорить. Если только они не<br>
затягиваются слишком надолго, а продукт начинает считаться уже взрослым...</p>
<p>Основной сервер, напомним, работал в городе, на машине, с которой выходил и<br>
сам #Kpot#. Альтернативный работал в общаге на машине Хилкова. Реализация<br>
таймаутов была такой, что сендер частенько "отваливался" и переключался на<br>
альтернативный. А вот связи между основным и альтернативным &mdash; не было никакой.<br>
Они не были сетью серверов наподобие IRC-сети. Так что клиенты оказывались<br>
разделены на две части.</p>
<p>Для решения этой проблемы, вместо починки работы с сетью (а работа по Томску<br>
мало чем отличается от общаги, это не внешка), Крот решил перенести основной<br>
сервер в общагу, на основной unix-сервер hostel. Администрацией сети проект,<br>
поддерживающий совместимость с TCPSender, был воспринят положительно, и<br>
Java-сервер был запущен на хостеле.</p>
<p>Тут начала повторяться забавная ситуация. Сервер запускался, работал<br>
примерно 5 дней и падал (причем падал аварийно, в корку). Срок варьировался,<br>
но всё повторялось регулярно. За сервер отвечал Вадим Гончаров (nuclight),<br>
техник актива AVTF.Net, проследив за процессом сервера в очередной раз, он<br>
увидел, что при запуске размер виртуальной памяти сервера составляет чуть<br>
более 200 Мб (и подивился, чего так много для такой сравнительно простой<br>
задачи). Затем размер постоянно растет, упирается в административный лимит<br>
256 Мб &mdash; после чего процесс аварийно завершается. На машине Крота проблема,<br>
понятно, возникать не успевала (чаще сервер апдейтился для новых фич), потому<br>
что на сервере не было лимитов, ибо ему не нужно было обслуживать кучу других<br>
задач для всей сети.</p>
<p>Это было похоже на явную утечку памяти, и чтобы удостовериться, что здесь<br>
проблема не JVM, nuclight 26 мая сходил на канал #java в RusNet, задав там этот<br>
вопрос. На что получил ответ "если память у жабы кончается, это 98% программера<br>
проблема" и совет передать программеру гуглить по "java memory leaks", мол,<br>
имеется ряд статей.</p>
<p>Что и сделал. Удивительно, однако, что ничего не изменилось. Впрочем, здесь<br>
можно было бы сказать &mdash; "сессия!", но ничего не изменилось ни летом, ни осенью.<br>
Хуже того, каждые 5 дни Крот логинился на хостел и перезапускал сервер вручную.<br>
В таких случаях, если нет времени и желания, стандартные, доступные рядовому<br>
пользователю средства Unix легко позволяли соорудить "костыль" &mdash; автоматический<br>
перезапуск при падении. Проблему не устраняет, но нет хотя бы downtime (времени<br>
неработы), пока сервер лежит, и это еще не починено. Но не было сделано даже<br>
этого, Крот продолжал делать всё вручную.</p>
<p>К тому времени было видно, как медленно проект развивается &mdash; SPSender за<br>
гораздо меньший срок уже обладал более полной функциональностью. Как не<br>
решается проблема сервера. Как выбираются решения похуже, но попроще &mdash; есть<br>
подозрение, например, что менее удобное цитирование со строкой-разделителем<br>
было алгоритмически сделать проще, чем более удобное у TCPSender. Насмотревшись<br>
на всё это, nuclight решил исследовать вопрос, как можно принципиально улучшить<br>
сендер, чем и занялся в июле, уехав на каникулы.</p>
<p>Разработчики же за лето сделали не так много &mdash; закончили чат да приделали<br>
архив сообщений (ведется с 18 августа, доступен и сейчас). Архив был сделан на<br>
Web &mdash; в меню программы выбирается пункт, открывается браузер со страницей, на<br>
которой доступны все публичные сообщения. Так была решена проблема "повторите<br>
кто что писал, у меня сендер вылетел", а также тех, у кого был выключен<br>
компьютер. Архив стал первым существенным новшеством, которое SEA Sender<br>
привнёс по сравнению со своими предшественниками.</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h3>Осеннее обострение</h3></a>
<p>Всё началось в конце августа, когда народ в основном вернулся с каникул.<br>
Сендер был улучшен, например, добавилось удаление только прочитанных. Мало кто<br>
заметил, однако, что новая версия принудительно убивала процесс TCPSender,<br>
таким образом, держать оба сразу теперь не представлялось возможным. В то же<br>
время начинается бурление &mdash; число пользователей нового приближалось к числу<br>
пользователей старого, была уже примерно половина. В связи с чем от наиболее<br>
активных энтузиастов стали поступать предложения всем перейти на новый, сделав<br>
его официальным. Все эти бурные дискуссии сохранились в архиве за 2006 год<br>
(каждый может перечитать при желании), поэтому эту историю можно изложить более<br>
подробно.</p>
<p>Разработчики сендера почувствовали силу и стали вести себя менее<br>
корректно. Например, одним из наиболее популярных вопросов в сендере был<br>
"кто печатает?", на втором месте шли объявления о продаже внешки. И если<br>
о печатниках Крот (почти всегда от имени разработчиков писал он) согласился<br>
подумать, то на предложение сделать визуальную индикацию и провайдеров<br>
внешки ответил "жирно будет". Аналогично (хотя более вежливо) он ответил и<br>
на просьбу сделать в чате поддержку <tt>/me</tt> и оставление окна чата<br>
открытым, если с той стороны его уже закрыли (закрывалось и тут, можно было<br>
не успеть переписать). Последнее, впрочем, позднее было сделано как<br>
доступный в меню лог последнего чата.</p>
<p>Поддержку списка отосланных сообщений (как <a href='#img-tcps-sentmsgs'>это<br>
было в TCPSender</a>) он обещал, но так никогда и не сделал. Аналогично<br>
24 сентября была обещана поддержка пересылки файлов, которая тоже никогда<br>
не была сделана.</p>
<p>Хуже стало и с починкой багов. Сообщили, что при наборе ответа в привате<br>
по непонятным причинам уходит пустое сообщение на всех и закрывается окошко<br>
набора сообщений &mdash; после разбирательства всё же подтвердили, что это все таки<br>
баг, но делать ничего не стали. Цитирование иногда не подставляло ник, с этим<br>
тоже бороться не стали.</p>
<p>Вместо этого общественность всё более была занята обсуждением, что "нас уже<br>
много", и пора бы уже "всем перейти на новый". Отдельные наивные энтузиасты<br>
даже выдвигают предложение "в полночь всем разом взять и перейти". Естественно,<br>
ничего такого не произошло &mdash; да и не могло. К сожалению, они не осознавали<br>
полностью, почему нужна совместимость, и считали, что раз количество перевалило<br>
за половину, то она более не нужна. Увы, никто не привел сравнения с<br>
коммерческими программами, где даже 20% рынка &mdash; это значительный кусок. Ведь<br>
сендер-то был некоммерческий... Однако принципы поведения пользователей при<br>
этом неизменны (например, браузеры уже много лет бесплатны, тем не менее, речь<br>
о проценте рынка вполне идет).</p>
<p>19 сентября Kim (Алексей Лепустин, одногруппник Shaddix'а, тоже олимпиадник)<br>
выступает против SEA Sender'а за приваты: из старого в новый можно писать<br>
в приват, но нельзя отвечать в приват. Однако невозможно из нового сендера в<br>
приват старому написать. По этой причине он вынужден оставаться на старом &mdash; так<br>
с ним смогут связаться все, а не только те, кто пользуются SEA (он печатник, и<br>
для него это важно &mdash; влияет на уровень доходов, понятное дело). То же самое, и<br>
даже в большей степени, применимо и к активу сети &mdash; в дискуссии встрял nuclight.<br>
К сожалению, им не удалось донести свою точку зрения до противоположной стороны.<br>
Оппоненты не поняли, что гарантированная связь в обе стороны суть проблема не<br>
пользователя с той стороны, а того же актива. Если б актив перешел на SEA, и<br>
ему пишет пользователь со старого, пишет с проблемой &mdash; надо иметь возможность<br>
ему ответить. Потому что нельзя <i>заставить</i> всех пользователей перейти на<br>
один и тот же клиент.</p>
<p>Кроме того, в этот день поступил ряд интересных предложений по группам &mdash; в<br>
старом сендере они были, тут не было. А было бы удобно. Но они остались<br>
проигнорированы разработчиками.</p>
<p>20 сентября, наблюдая кучу флуда, интересного далеко не всем, Shaddix<br>
предложил сделать сообщениям приоритеты. Это была отличная мысль, актуальная и<br>
поныне &mdash; пользователи сендера делятся на тех, кто не прочь пообщаться, и тех,<br>
кто хочет читать только объявления. Но, к сожалению, и на эту идею никто не<br>
обратил внимания. В тот же день Kim сообщает, что у него глючит и прямая<br>
отправка (неработавший ответ можно было заменить написанием нового двойным<br>
щелчком в списке, новый сендер уже начал обзаводиться собственными способами<br>
обхода багов).</p>
<p>21 сентября, чтобы не было всего этого флейма, предложили сделать голосование<br>
прямо в интерфейсе сендера. Разработчики ответили, что проще сделать страницу<br>
на php, но не сделали даже и её.</p>
<p>22 сентября поступает жалоба: мол, у всех нормальных людей если в программе<br>
что-то изменилось &mdash; меняется версия, тут же под одной версией 0.9.6 гуляет куча<br>
разных вариантов. В самом деле, запутывающий пользователя подход. Кроме того,<br>
подняли вопрос про разделители цитирования (ту самую -==-==- между цитатами) &mdash;<br>
многим она была неудобна. Мнения разделились. Поступило и третье решение, самое<br>
правильное (потому что так делают почтовые клиенты) &mdash; выделять цветом цитаты<br>
разных людей разным цветом. #Kpot# же сказал так: &laquo;Хотя бы человек 10<br>
остановится на одном и том же &mdash; сделаю&raquo;. Звучит как гарантия, но с<br>
учетом того, что их всего-то в обсуждении участвовал десяток, этого опять-таки<br>
никогда не произошло.</p>
<p>В тот же день Алексей Алыков (Muzzy), аспирант, занимающийся компьютерной<br>
безопасностью, заинтересовался "косяками" SEA Sender'а. Никто не придал тогда<br>
этому значения.</p>
<p>23 сентября выходит версия 0.9.7: в ней добавилась возможность смены ника,<br>
иконка в трее стала серой, если все сообщения были прочитанными. Но самым<br>
важным нововведением были "Печатники" &mdash; еще одна группа, сообщения которой<br>
доставлялись тем, кто в ней состоял. Добавить себя в неё можно было, нажав на<br>
панели инструментов кнопку со значком принтера. Однако визуальной идентификации<br>
печатников в интерфейсе никакой не было &mdash; пользователь вынужден был отправлять<br>
им вопрос вслепую. Гораздо более корректным решением, на самом дело, было бы<br>
ввести фильтрацию в клиенте по ключевым словам &mdash; печатники могли бы на это<br>
реагировать, а сендеры остальных могли бы такие назойливые сообщения просто не<br>
показывать. Тем более, что задание подстрок для поиска тривиально расширяется и<br>
для любой другой подобной потребности. Здесь же для каждого такого случая всем<br>
пришлось бы обновлять клиент (не говоря уже о сервере и поддержке в протоколе).</p>
<p>Еще в этот день была поднята тема, зачем нужна защита архива. Дело в том,<br>
что к урлу каждый раз приписывался уникальный 4-значный id, если он был<br>
некорректен, то архив нельзя было просмотреть. Был получен ответ: чтоб могли<br>
просматривать только пользователи SEA. Дескать, конкурентное преимущество.<br>
#Kpot# пообещал: &laquo;После отключения совместимости уберу. Ближайшее время<br>
будет действовать то и другое&raquo; (впрочем, 24 сентября он и пересылку<br>
файлов пообещал). Но выполнил обещание только через несколько месяцев. На что<br>
nuclight ему заметил, что организовать чтение архива в принципе &laquo;может<br>
сделать любой пользователь с хомой на хостеле, без всяких админских прав&raquo;.<br>
Но Крот не понял, каким образом. В следующем подразделе будет описано, как.</p>
<p>25 сентября началось всё самое интересное. Сначала вылез баг, когда в списке<br>
один человек появился кучу раз. Как выяснилось, у него глючила сеть &mdash; клиент<br>
входил много раз. Решили проблему несколько криво &mdash; просто ограничили число<br>
входов с одного адреса. Теперь, когда у человека проблема исчезала, он был<br>
вынужден ждать, пока "фантомы" не исчезнут &mdash; до тех пор его не пустит. Случился<br>
и другой глюк сервера, наблюдавшийся потом время от времени еще пару лет:<br>
Shaddix задал о нем вопрос &laquo;А почему меня нет у меня в списке и<br>
сообщения, отправленные мной, подписываются другими юзерами?&raquo;. Видимо,<br>
пользователей SEA стало слишком много, и нагрузка выявила доселе "дремавшие".<br>
<p>Позже начались глюки с кучей Muzzy в списке. Но у него глюков сети не было.<br>
А потом... потом в сендере внезапно оказалась 1000 сообщений. Как выяснилось<br>
позже (не публично), это Muzzy (помните его вопросы несколькими днями ранее?)<br>
"поигрался" с новым сендером. Никакой защиты от злоумышленников, флуд-контроля,<br>
подобного тому, что на IRC-серверах, предусмотрено не было. Muzzy эксперименты<br>
с подобным публичным исходом более не повторял (хотя кто знает, что он делал<br>
незаметно), чтобы не "засветиться".</p>
<p>Но разработчики, видимо, не поняли, что именно произошло. Здесь они допустили<br>
ошибку: <b>в проблемах с безопасностью следует разбираться, чтобы тот же<br>
способ нарушения не был использован еще раз</b> (и спустя полтора месяца это<br>
таки вышло им боком). К сожалению, они не стали разбираться (и вообще фиксить<br>
баги), а пошли наиболее простым путём:</p>
<blockquote>21:43:13 25 сентября 2006 #Kpot#<a href='FreeWay.md'>FreeWay</a>:<br>
Для уменьшения глюков поддержка старого сендера отключена.<br>
В ближайшие дни мы полностью перепишем сервер, тогда все глюки точно исчезнут<br>
<br>
<br>
Unknown end tag for </blockquote><br>
<br>
<br>
<p>26 сентября вышел SEA Sender версии 0.9.7.3 &mdash; но исправлено было только<br>
несколько багов, не более того.</p>
<p>27 сентября было обсуждение, когда окно сендера при получении сообщения<br>
следует разворачивать из трея. Проскочило предложение "когда в сообщении есть<br>
твой ник", которое снова не было услышано. Выше уже упоминался способ решения<br>
проблемы печатников фильтрацией сообщений по текстовым подстрокам &mdash; им можно<br>
было бы решить и эту потребность. Кроме того, было обещание версии сендера со<br>
встроенным браузером. Излишне упоминать, что это так же никогда не было<br>
сделано.</p>
<p>28 сентября снова обсуждали, что всё равно много кто спрашивает про печать в<br>
общак, несмотря на печатников. Пока что сошлись на том, что не все еще поставили<br>
себе новую версию. Юзеры стали задавать вопросы, почему поддержка старого<br>
сендера отключена, там же еще был народ, объявления по срокам оплаты, например.<br>
Ведь актив сети остался на старом сендере &mdash; в том числе по причине того, что<br>
два одновременно запустить было нельзя (SEA Sender убивал процесс старого). На<br>
что #Kpot# ответил, что там осталось меньше 10 человек. На самом деле их было<br>
больше, так как он смотрел из города (не учел <a href='#tcpsbugs'>проблемы</a>
старого сендера, мешавшие адекватному подсчету всех). А также высказался в духе<br>
"Вадима жаба давит", и другие оскорбительные высказывания для администрации<br>
сети в целом.</p>
<p>На что администрация сети просто молча забанила его IP от всей сети общаги.<br>
Сервер сендера на хостеле продолжал работать. Но, как ранее уже было описано,<br>
никакой автоматизации предусмотрено не было, проблема с утечкой так и не была<br>
решена. И через день он просто упал, а Крот был не в состоянии его поднять (или<br>
же попросить сделать этого кого-то в общаге). Причем альтернативный сервер на<br>
тот момент был в городе, в результате с 30 сентября по 5 октября 2006 те, кто<br>
перешел на SEA, сидели без связи. Некоторые вернулись на TCPSender.</p>
<p>Через несколько дней разработчики SEA Sender выяснили, что произошло, и<br>
договорились о встрече с администратором (YaM_DJ, Михаил Яговкин). В комнату<br>
506, где присутствовал администратор и актив, пожаловала целая делегация,<br>
кроме обоих разработчиков, там еще были Shaddix и Вадим Дашкевич (Sandman), а<br>
также некоторые другие энтузиасты, но лишних попросили удалиться.</p>
<p>Разговор был долгим.</p>
<p>Разработчики считали, что SEA Sender должен быть принят как официальное<br>
средство общения пользователей в сети (на которое ссылался бы Устав) и что<br>
сервер SEA должен находиться на хостеле. Администрация сети считала, что<br>
SEA Sender не готов в качестве такой замены &mdash; еще не реализована часть<br>
возможностей, не устранен ряд проблем. А потому в настоящий момент принят он<br>
не будет, до тех пор же, пока он не станет удовлетворять условиям, обязательна<br>
поддержка старого сендера (для хостинга сервера на хостеле). Существенной<br>
проблемой являлся вопрос также безопасности: исходники SEA были закрыты, автор<br>
жил не в общаге, а в городе, и программа уже была замечена в двух случаях<br>
несанкционированного поведения &mdash; убивание процесса TCPSender без спросу, а<br>
также управляющие команды клиентам через сервер (разработчики использовали их<br>
для смены IP альтернативного сервера клиентам). Не было никаких гарантий, что<br>
подобных "закладок" не найдется еще &mdash; и администрация подчеркнула, что для<br>
деканата хватило бы уже вышеуказанного, если что. Админская паранойя, кстати,<br>
их не подвела &mdash; через месяц был обнаружен баг с переполнением буфера, который<br>
потенциально мог бы быть использован для удаленного исполнения кода...</p>
<p>Затрагивали вопрос и других багов. Утечки памяти в сервере разработчики<br>
объяснили тем, что треды сканирования старого сендера иногда "подвисали", и они<br>
не знали, что с этим делать. Но и принципиально не хотели фиксить этот баг.</p>
<p>В конце концов решили так: разработчики SEA Sender обязуются устранить<br>
убивание старого сендера, чтобы пользователи могли пользоваться обоими, могли<br>
свободно выбирать. Новый сендер пусть развивается, но с сервером не на хостеле,<br>
раз поддержки старого не будет &mdash; когда станет готов, пусть приходят снова.<br>
Вадим Дашкевич (Sandman) из комнаты 310 поднимает сервер и сайт проекта на<br>
своей машине, администрация же выделяет ему дополнительное имя sea.avtf.net<br>
(что делалось редко для кого). На том и порешили.</p>
<p>В конце, перед тем, как все разошлись, Крот, к его чести, признал, что да,<br>
в программе существует ряд проблем. Остальные этого не признали.</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h3>Холодная война и железный занавес</h3></a>
<p>На том всё затихло. Администрация сети и еще некоторое количество юзеров<br>
остались на старом сендере, остальные с 5 октября стали жить на новом. Бурных<br>
дискуссий теперь почти не было, "революция" прошла.</p>
<p>Но разработчики SEA соглашения выполнять не торопились &mdash; версии, которая бы<br>
давала TCPSender'у жить спокойно, выпущено не было ни сразу, ни через два дня.<br>
Зато был с помпой открыт сайт сендера на базе стандартного движка DLE, но и на<br>
том ничего толком не работало, кроме комментариев к новостями и скачки<br>
дистрибутива. Планировался форум, но пока он был недоступен. Даже архив &mdash; и тот<br>
по-прежнему открывался только из SEA Sender, несмотря на обещание от 23<br>
сентября убрать его после отключения совместимости.</p>
<p>Справедливо рассудив, что слово надо держать, а коль, не держишь, так это<br>
дает право на ответные действия, администрация соорудила для себя простенький<br>
CGI-скрипт, позволявший читать архив без запущенного сендера:</p>
<blockquote><pre><font color=#696969>#!/bin/sh</font><br>
<br>
id<font color=#808000>=</font><font color=#0000e6>nc sea </font><font color=#008c00>8733</font><font color=#0000e6> | cut -b </font><font color=#008c00>1</font><font color=#0000e6>-</font><font color=#008c00>4</font><font color=#0000e6><br>
<br>
Unknown end tag for </font><br>
<br>
<br>
<br>
<font color=#800000>exec</font> cat <font color=#808000>&lt;&lt;</font> EOF<br>
Content<font color=#808000>-</font>Type<font color=#808000>:</font> text<font color=#808000>/</font>html<font color=#800080>;</font><br>
<br>
<font color=#90029a>&lt;html&gt;</font><font color=#90029a>&lt;head&gt;</font><font color=#90029a>&lt;title&gt;</font>SEA Sender Archive Link Generator<font color=#90029a>&lt;/title&gt;</font><font color=#90029a>&lt;/head&gt;</font><font color=#90029a>&lt;body&gt;</font><br>
<font color=#90029a>&lt;a href=</font><font color=#0000e6>"</font><font color=#0000cc>http://sea.avtf.net/archive/archive.php?id=</font><font color=#007997>$id</font><font color=#0000e6>"</font><font color=#90029a>&gt;</font>SEA Sender Archive<font color=#90029a>&lt;/a&gt;</font><font color=#808000>.</font><br>
Reload this <font color=#808000>.</font>cgi page if link is not valid<font color=#808000>.</font><font color=#90029a>&lt;/body&gt;</font><font color=#90029a>&lt;/html&gt;</font><br>
EOF</pre></blockquote>
<p>Здесь в двух строках полезной нагрузки делался коннект к серверу на порт<br>
8733 (основной сендер работает на порту 8732), и получалась строка, из которой<br>
вырезалось 4 символа id (их там было два &mdash; текущий и предыдущий). Отдавался он<br>
сервером php-скриптам архива, те пускали пользователя по любому из двух. Просто<br>
беспечные авторы оставили его открытым всему миру &mdash; что ж, не стоило бездумно<br>
хвастаться своей защитой вместо реальных дел.</p>
<p>Впрочем, ничего интересного по теме сендера там почти не происходило. Позже,<br>
однако, разработчики позволили себе дерзость &mdash; на IP-адреса актива определенное<br>
время вместо архива отдавалась страница 403 с изображением среднего пальца. На<br>
случай, если бы актив таки запустил SEA Sender, видимо. Администрация не стала<br>
реагировать на эту совсем уж детскую выходку. Спустя месяц сами одумались и<br>
убрали.</p>
<p>А вот что-то более полезное делать не спешили. 7 октября их спросили про<br>
неработающий форум на сайте. Форум заработал только 24 числа. 8 октября на<br>
арене появляется Семён Тян (Peek), один из героев дальнейшего повествования. Он<br>
сначала вполне поддерживал авторов, 19 сентября выразил им публичную<br>
благодарность, поддерживал предложение всем взять и перейти разом. Теперь же,<br>
похоже, его мнение постепенно начало меняться. Итак, 8 октября он начал кидать<br>
длинные сообщения, видимо, чтобы посмотреть, каков лимит. Кроме того, в этот<br>
день снова наблюдались глюки с никами &mdash; а ведь поддержка TCPSender уже была<br>
отключена, утверждалось, что глюки вызывала именно она.</p>
<p>14 октября Peek спрашивает, где задать вопросы разработчикам, и не получает<br>
ответа.</p>
<p>21 октября было несколько событий. Снова кто-то задавал вопросы, почему его<br>
в списке "двое". На сцене появился Михаил Логинов (Мишаня<a href='AMD.md'>AMD</a>), активист сети,<br>
живший в одной комнате (307) с Семёном (Peek). Единственный из актива, кто на<br>
тот момент использовал SEA Sender. Он сообщает о баге: &laquo;когда жмешь<br>
ответ и начинаешь чепятать то любой кейпрес воспринимается как<br>
ctrl+enter&raquo;. Человек он вспыльчивый, и его раздражение на баг вылилось<br>
в кучу пустых сообщений на группу.</p>
<p>Кроме того, актив в этот день, после полутора месяцев напряженной работы,<br>
ввёл в строй телевещание по сети. Специально для этого случая nuclight запустил<br>
SEA Sender, чтобы сообщить о новости, и не преминул пнуть разработчиков за то,<br>
что он тут ненадолго, потому что одновременно два сендера держать запущенными<br>
невозможно, несмотря на обещание выпустить такую версию и приватное напоминание<br>
об этом разработчикам в середине месяца.</p>
<p>Публичное напоминание, видимо, возымело действие, и 23 октября Sandman<br>
сообщил о выпуске SEA Sender 0.9.7.4 &mdash; версии, которая на самом деле стала<br>
последней. Да, теперь стало возможным держать запущенными оба сендера сразу. Но<br>
никаких других улучшений и даже исправлений ошибок в ней не было, кроме правки<br>
таймингов коннекта для городских пользователей.</p>
<p>А баги проявились, причем и еще доселе невиданные. Сначала 25 октября сервер<br>
стал надолго лагать, и потом разом выплевывать все сообщения в одну секунду.<br>
Задержка достигала десятков минут! У клиентов же случались вылеты при звонке в<br>
чат. Затем 27 октября, кроме Семёна и Мишани, уже и другие пользователи начали<br>
подтверждать, что есть баги. Вспомнили и про давно обещанную кнопку перехода по<br>
ссылке. Да-да &mdash; в SEA Sender всех версий необходимо было каждый URL выделять<br>
мышью и вручную копировать в браузер. И если в 1998 году Интернета в общаге<br>
скорее не было, чем был, и TCPSender имеет оправдание, то в новом &mdash; это просто<br>
неудобно. Тем не менее, 27 октября Peek всё еще считал SEA Sender лучше.</p>
<p>30 октября снова поступили жалобы "гонит сендер", "жрет мессаги". Никакой<br>
реакции. Более того, Мишане приходилось притаскивать Дашкевича пешком и<br>
показывать ему, что баг на самом деле есть &mdash; разработчики иначе просто не<br>
верили.</p>
<p>2 ноября Peek и Мишаня начали играться с ограничениями на символы в нике. И<br>
Мишаня получил бан за то, что оказался первый в списке &mdash; #Kpot# соперничества в<br>
таких мелочах не терпел, и его ник обычному пользователю было ввести в<br>
настройки невозможно.</p>
<p>Столь детская выходка получила детский же ответ &mdash; 3 ноября Мишаня начал<br>
демонстративно писать с разными неудобоваримыми никами (он из таких людей, кто<br>
в ответ на ограничения только распаляется). И 5 ноября получил за это бан на<br>
неделю.</p>
<p>9 ноября Peek спросил: &laquo;а кто нить мне может дать ответ на<br>
вопрос какого это фига при невыделнном ни нике ни группе при нажатии на ЕНТЕР<br>
сендер предлогает мне запостить мессадж а?&raquo;. Баг подтвердил не только<br>
Семён.</p>
<p>10 ноября #Kpot# пишет насчет оскорблений и матов в сендере, дескать, его<br>
месяц назад забанили вообще без мата, и теперь он будет банить в сендере на<br>
свое усмотрение, &laquo;пока актив сети не "признает" SEA сендер&raquo;. На<br>
этом фоне уже незамеченными прошли баг-репорты о <a href='#img-seabug07'>заднем<br>
фоне окна информации о пользователе</a> и возможности печатать в общей части<br>
окна чата...</p>
<p>13 ноября #Kpot# объявил:</p>
<blockquote>
В SEA Sender'е есть ограничение на использование символов в никах. Однако,<br>
некоторые товарищи нашли, как обойти ограничение, влезая в файлы<br>
конфигурации. Отныне такие действия будут пресекаться, а данные товарищи &mdash;<br>
получать баны<br>
</blockquote>
<p>Здесь разработчики допустили сразу две ошибки, сродни той, что обсуждалась<br>
ранее, по безопасности. Одна &mdash; это то, что <b>не следует заведомо бессмысленно<br>
ограничивать пользователя &mdash; найдутся такие, которые захотят "восстановить<br>
справедливость"</b>. А если программа распространяется по всему Интернету,<br>
вероятность, что среди них найдутся способные причинить ущерб, уже не так мала.<br>
Другая ошибка: <b>все проверки данных на корректность в сетевых приложениях<br>
следует производить на сервере, потому что злонамеренный пользователь может<br>
взломать клиент или вообще написать свой</b>. В данном случае сочетание сразу<br>
двух этих ошибок привело к тому, что, по-видимому, Семён<a href='Peek.md'>Peek</a> вконец обиделся<br>
на такое отношение разработчиков, и занялся непосредственно протоколом и<br>
сервером.</p>
<p>Первая его попытка была неудачна &mdash; 14 ноября Peek получил бан по IP за<br>
неудачно засланные данные по telnet к серверу. Мотивировка была "за эксперименты<br>
над стабильностью сервака". Однако здесь разработчики должны были сделать и<br>
еще один вывод: раз сервер нестабилен, надо это исправить, пока "хакер" еще<br>
сидит в бане и не угрожает. Потому что это, фактически, проблема безопасности.<br>
По сути, они повторили ту же ошибку, что и в сентябре: <b>не следует<br>
игнорировать проблемы безопасности и сообщения о них</b>. И расплата не<br>
заставила себя долго ждать.</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h3>Почти детективная история</h3></a>
<p>Как позже вспоминал Семён, этот бан его "выбесил", и он стал копать сначала<br>
с другой стороны. Он самостоятельно нашел еще один способ чтения архива без<br>
ссылки из клиента: оказывается, достаточно было просто выставить переменную в<br>
active=1 в POST-запросе. Подивившись простоте, Peek решил попробовать самые<br>
элементарные уязвимости, которые встречаются в Вебе.</p>
<p>Сервер (как узнали позже) дописывал сообщения (окружив их тегами) прямо в<br>
статические php-файлы, которые читались основным скриптом. Никакого<br>
экранирования символов в сообщениях он не делал. В результате скоро читатели<br>
архива увидели в нем порнографические картинки &mdash; некто с именем компьютеров с<br>
кафедры ВТ отправил сообщения с тегами <tt>&lt;img&gt;</tt>. И они были<br>
показаны. Атака довольно безобидная &mdash; потому что таким образом и JavaScript<br>
можно включить. Семёна, однако, заметила на кафедре однокурсница, имевшая в<br>
сендере ник <acronym title="по прозвищу &laquo;Страшная&raquo;, что дали ей<br>
на потоке">"Ленуся"<br>
<br>
Unknown end tag for </acronym><br>
<br>
. И конфликт получил новый виток.</p>
<p>Чтение и исполнение PHP-файлов, однако, тоже было сделано из рук вон плохо.<br>
Проблемы с безопасностью &mdash; вообще распространенное явление среди проектов на<br>
PHP, тем более, что <a href='/~vadim/phpbastard.html'>сам язык PHP на это<br>
провоцирует</a>... И Семён, найдя ляп, который можно было эксплуатировать для<br>
получения контроля над сервером, задумал страшную месть.</p>
<p>Дальше события развивались совсем как в шпионском романе.</p>
<p>В субботу, 18 ноября, должно было состояться официально посвящение АВТФ, в<br>
концертном зале в Облсовпрофе. Все, наверное, знакомы с ним &mdash; каждая кафедра<br>
готовит номера в стиле КВН. Праздник потом продолжается всю ночь в общаге, с<br>
горячительными напитками. Время для диверсии &mdash; просто идеальное, при всеобщем<br>
веселье кому какое дело до работы каких-то серверов?..</p>
<p>Посвящение начиналось в 6 вечера. Перед ним Peek отправился в близлежащий (к<br>
месту Посвящения) компьютерный клуб. В самом деле, надо же заметать следы, ищи<br>
потом ветра в поле, когда логи ведут на публичный компьютер?.. Но разведку<br>
местности Семён не провел, и только потратил время зря &mdash; в этом клубе нельзя<br>
было запустить своих программ с флэшки (а попробовать что-либо с вырубленным<br>
эксплорером не позволяло время). Пришлось пойти на Посвящение и сидеть там,<br>
обеспечивая алиби ("я там был, меня видели, вот, подтвердят").</p>
<p>Досидев до середины, в один из удачно рассчитанных моментов, когда внимание<br>
зрителей было приковано к сцене, Peek вышел из зала, и, надвинув на глаза<br>
капюшон, двинулся в другой компьютерный клуб, "Nettown".</p>
<p>Там он сделал своё дело &mdash; контроль над сервером был получен. И возможность<br>
читать всю файловую систему &mdash; а сервер крутился на винде, на домашней машине<br>
Sandman'а. В частности, Peek утащил весь архив сообщений к тому моменту (позже<br>
это сослужило хорошую службу &mdash; только благодаря этому сейчас в архиве есть<br>
сообщения за 2006 год) и скомпилированный сервер сендера (толку с этого было<br>
мало, ибо не исходники). Но много ли возьмешь с одного раза? Peek попытался<br>
залить на сервер веб-шелл, чтобы иметь возможность контролировать его и потом.<br>
Тут начались проблемы &mdash; из-за той самой переменной шелл не хотел работать<br>
корректно, пришлось впопыхах его править. В конечном итоге всё прошло успешно,<br>
и Семён благополучно вернулся в общагу.</p>
<p>Прошло 2 дня. Никто ничего не заметил.</p>
<p>Но шпионы, как известно, попадаются на мелочах.</p>
<p>У Семёна взыграло тщеславие, и он решил добавить еще. Ранее он анализировал<br>
протокол путем перехвата трафика, этого не хватало на всё, но было<br>
достаточно, чтобы написать простенькую программу, могущую соединиться с<br>
сервером и отправить заранее подготовленное сообщение.</p>
<p>Такая программа была подготовлена, 21 ноября в обед Peek вновь отправился<br>
в Nettown, залил на чужой FTP в ТУСУРе свою программу, а в incoming на хостеле<br>
положил файл <tt>"Фотки с посвящениЯ.url"</tt> &mdash; расчет был на любопытного<br>
пользователя (а в это время народ уже отходил с бодуна и как раз начинал<br>
выкладывать, спрос был высок), и он оправдался с лихвой.</p>
<p>Семен пришел домой и лег спать. Проснулся вечером &mdash; общага гудела. В сендере<br>
то один, то другой пользователь слал сообщение "Сэндман дурак!!!" и HTML-код,<br>
ведущий на порнокартинки (сервер, правда, к тому времени уже пофиксили, XSS<br>
больше не работал). Все гадали, что это может быть, разработчики сендера<br>
предположили, что кто-то меняет IP-адреса (не очень обдуманное предположение,<br>
поскольку скорость была высокой, и нарушитель сразу был бы вычислен админами<br>
сети). Активу пришлось побегать по пользователям, было установлено, что это<br>
делает программа, имевшая в девичестве название SenderButNotReceiver.exe. Был<br>
выяснен и источник &mdash; .url-файл на FTP-сервере общежития. Анализ логов показал,<br>
откуда он был залит, и куда вёл.</p>
<p>У разработчиков SEA Sender были подозрения, что это сделал Peek, но не<br>
было доказательств. Получив сведения от администрации сети, они принялись за<br>
дело, и на следующий день знакомые Snadman'а в Nettown'е предоставили ему<br>
фотографии с камер видеонаблюдения, где Семён &mdash; увы &mdash; был со снятым<br>
капюшоном, лицо опознать не составляло проблем.</p>
<p>К Семёну в комнату пожаловал и актив, и разработчики. В инциденте он<br>
сознался, за надпись от программы извинился, а заодно рассказал и про взлом<br>
сервера. Такого поворота событий разработчики, мягко говоря, не ожидали. В<br>
какой-то степени, можно сказать, Peek своей цели добился. И получил максимально<br>
возможное по Уставу сети наказание &mdash; месяц полного отключения. Но больше<br>
никакие взломы хозяев сервера SEA Sender не беспокоили.</p>
<p>На том все страсти по сендеру в общаге бушевать перестали.</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h3>Времена упадка и запустения</h3></a>
<p>Да, разработчиков больше никто не трогал, они тоже больше ничего не делали.<br>
Но стоит пояснить некоторые моменты.</p>
<p>3 ноября Крот пишет, что, дескать, Вадим (nuclight) сам пишет сендер третий<br>
год, и потому так нападает, что обидно ему. Вадим действительно к тому моменту<br>
уже писал свой сендер, но не третий год, а еще и месяца не прошло. Ранее<br>
упоминалось, что в июле он начал исследовать вопрос. Вылилось это в<br>
документ-спецификацию, который был закончен в октябре. Актив сети не имел<br>
привычки выпускать продукт, который был бы еще совсем сырым, а не имел уже<br>
достаточно высокое качество и был пригоден к использованию. Так, в сентябре был<br>
сделан новый сайт хостела (который остался таким и поныне), актив переключился<br>
на вещание телевидения по сети &mdash; после напряженной работы 21 октября оно было<br>
запущено. Затем каждый занялся своим делом &mdash; админ Михаил Яговкин (YaM_DJ) стал<br>
разрабатывать следующую версию сайта, Мишаня поддерживал файловый архив и<br>
занялся улучшениями TV-клиента, Вадим почти дописал протокол и переключился на<br>
написание сервера нового сендера.</p>
<p>И всё это помимо основных обязанностей и прочей жизни студентов. Например,<br>
Вадим еще помогал 2 курсу с организацией Посвящения АВТФ. В результате сервер<br>
был закончен через несколько недель, потом был начат клиент. Но всё это<br>
делалось в одиночку (в отличие от всех предыдущих клиент-серверных попыток, где<br>
всегда участвовала команда минимум из двух человек). В результате был набросан<br>
лишь эскиз клиента, а потом началась сессия. А после нового года и YaM_DJ, и<br>
nuclight устроились на работу &mdash; и как новый сайт хостела, так и новый сендер<br>
(подробнее о нем будет <a href='#thsender'>соответствующем разделе</a>) &mdash; увы,<br>
навсегда остались недописанными.</p>
<p>Но на волне некоторой необычности взлома сендера и общей теме сендера,<br>
nuclight заинтересовался, что это за хакер такой. Так они с Семёном и<br>
познакомились, и Peek был единственный, кроме актива, кто увидел зачатки<br>
нового клиента. И позже занялся конструктивной деятельностью.</p>
<p>Ибо было чем &mdash; совершенно неожиданно (для обитателей сендера) Sandman сдал<br>
сессию и уехал на преддипломную. Сайт сендера и архив внезапно прекратили своё<br>
существование. Сервер потом полгода мыкался то у его сокомнатника, то у<br>
Shaddix'а. А архива не было совсем. Семёна такое положение дел не устраивало, и<br>
он получил домашний каталог на хостеле, где разместил свой собственный архив.<br>
Сообщения он туда помещал самописным клиентом &mdash; наработки по протоколу-то были.<br>
Этот архив просуществовал с 6 января по 17 июня, и тоже доступен сейчас в<br>
основном архиве.</p>
<p>Но архивом Peek не ограничился. Он сделал веб-форму отправки сообщения в<br>
сендер, для тех, например, кто был на кафедре и не имел там установленного<br>
сендера. Сделал клиента-бота, который умел сообщать погоду. И, конечно же, стал<br>
писать (на Delphi) взамен "глючного штатного" писать свой собственный клиент,<br>
назвав его BlastCore Sender.</p>
<p>4 февраля 2007 года вышла первая версия BlastCore. Она еще ничего толком<br>
не умела, но можно отметить некоторые интересные решения, которые в ней были<br>
сделаны. Если все предыдущие сендеры были просто клонами TCPSender, то в<br>
BlastCore, например, Peek отказался от показа списка сообщений в combobox<br>
(выпадающем списке). Теперь они были представлены на отдельной панели в<br>
табличной форме, и можно было, например, выделить галочками несколько сообщений<br>
сразу.</p>
<p>В апреле BlastCore стал поддерживать чат (правда, пока еще только с одним<br>
человеком за раз), и научился сворачиваться в трей &mdash; заодно добавилась новая<br>
интересная возможность, показывать пришедшее сообщение прямо над треем, как это<br>
делают, например, современные клиенты ICQ. 30 мая был публичный анонс в сендере,<br>
и в начале июня вышла последняя версия 0.1.13, после которой началась<br>
дипломная пора, и BlastCore остался недоделанным очень надолго, поскольку<br>
потом Семён закончил ТПУ и уехал.</p>
<p>Осенью проблема размещения сервера возникла вновь, ибо все его хостеры<br>
позаканчивали, а администрация по-прежнему была против. Знакомый Крота<br>
Bisaram (Евгений Чернявский), тоже городской, поднял сервер на своем ADSL. Это<br>
решение оказалось не лучшим &mdash; сендеры в общаге стали частенько вываливать<br>
сообщения об ошибках с сокетами. Разработчик (на тот момент Крот остался один,<br>
будучи на 6 курсе магистратуры, а Сергей Хилков уже закончил ТПУ) объяснял это<br>
тем, что серверу лучше стоять в общаге, задержки, мол, меньше. Баги же править<br>
не хотел.</p>
<p>В обед 21 ноября 2007 года обсуждение багов в сендере снова вылилось в<br>
перепалку #Kpot# и nuclight, своеобразный рецидив старых времён. Архив тогда<br>
не вёлся, и поэтому фрагменты переписки приводятся прямо здесь (орфография<br>
оригинала сохранена):</p>
<blockquote><b>Вадим &ndash;&gt; АВТФ:</b><br>
<br>
uuu&gt;пишешь сообщение, отправляешь, а оно не выводиться<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
vadim&gt;только вчера про это писал, что оно тормозит &mdash; минут 5 подождать надо :)<br>
vadim&gt;ну и давайте снова хором попросим авторов сендера, чтоб поправили баги :)<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
#Kpot#&gt;Давайте для начала хором попросим товарища администратора сети<br>
обеспечить хост для сервера на хостеле.<br>
#Kpot#&gt;При нынешней позиции клуба автф.нет не вижу смысла в развитии<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
Собсно, когда чуть больше года назад был разговор администрации сети с<br>
авторами сендера, то на том как раз и порешили, что хостинга не будет, пока<br>
не сендер не достигнет приемлемого качества.<br>
Похоже, авторы сендера об этом забыли, ибо не то что каких-то серьезных<br>
улучшений, а вообще никакого развития не было за год. Абсолютно, даже фикса<br>
мелких багов...<br>
<br>
<b>Крот &ndash;&gt; Вадим, приват:</b><br>
<br>
Ваше условие было &mdash; возврат поддержки tcp-сендера<br>
Поддержки не будет, тк пользователям она не нужна.<br>
Хостинг как раз таки необходим для повышения качества, а не наоборот. Пока он<br>
был, качество повышалось, разве не так?<br>
Короче, какова ваша позиция сейчас<br>
<br>
Unknown end tag for </blockquote><br>
<br>
<br>
<p>На самом деле, как описано в <a href='#seautumn'>подразделе за сентябрь<br>
2006</a>, да, было "не так". Качество улучшалось лишь до того, как встал<br>
ребром вопрос о багах, причем не зависело это, был сервер на хостеле или<br>
нет. Такого ультиматума вообще не должно стоять &mdash; что качество программы<br>
улучшается только до тех пор, пока даются какие-то льготные условия. В ряде<br>
случаев такую поддержку еще заработать надо. Но если в случае конкретно с<br>
поддержкой TCPSender разработчиков еще можно понять, то вот со многими<br>
другими багами и предложениями, выдвигавшимися остальными пользователями<br>
сети &mdash; уже нет. Единственным заметным "повышением качества" в сентябре<br>
2006, пока сервер еще был на хостеле, стали "Печатники". Но программа<br>
вступила в ту фазу, когда для повышения качества нужно в большей степени<br>
фиксить баги, чем добавлять новые фичи. А как раз это-то и не делалось<br>
(кроме совсем уж мелких), были только разговоры да так и невыполненные<br>
обещания.</p>
<blockquote><b>Крот &ndash;&gt; Вадим, приват:</b><br>
<br>
vadim&gt;Разговор был длинный, и поддержка была не единственным условием, просто<br>
наиболее актуальным на тот момент &mdash; вспомни ее причины и прочее<br>
обсуждение.<br>
vadim&gt;Оно, скажем, могло бы уже потерять актуальность на данный момент и<br>
пересмотрено, но с вашей стороны к тому подвижек не было абсолютно никаких<br>
(хотя мы совершенно не препятствовали, даже наоборот, например, вы попросили<br>
- мы выделили домен sea, и т.д.).<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
не знаю не знаю. Точто помню , Ям сказал: вернете поддержку, сразу будет вам хостинг<br>
Так всё-таки какова ваша позиция сейчас<br>
<br>
<b>Крот &ndash;&gt; АВТФ:</b><br>
<br>
vadim&gt;Собсно, когда чуть больше года назад был разговор администрации сети<br>
с авторами сендера, то на том как раз и порешили, что хостинга не будет, пока<br>
не сендер не достигнет приемлемого качества.<br>
vadim&gt;Похоже, авторы сендера об этом забыли, ибо не то что каких-то<br>
серьезных улучшений, а вообще никакого развития не было за год. Абсолютно,<br>
даже фикса мелких багов...<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
Пи#@ёжь и провокация! совсем другое вы год назад говорили<br>
<br>
<b>Вадим &ndash;&gt; АВТФ:</b><br>
<br>
#Kpot#&gt;не знаю не знаю. Точто помню , Ям сказал: вернете поддержку, сразу<br>
будет вам хостинг<br>
#Kpot#&gt;Так всё-таки какова ваша позиция сейчас<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
Я уже озвучил выше &mdash; требование поддержки старого сендера было наиболее<br>
актуально именно на тот момент, а сам разговор был длинный, про безопасность<br>
и много чего еще.<br>
Порешили на том, что состояние SEA сендера пока недостаточно для его принятия<br>
официально, и пока что пусть сосуществуют оба клиента независимо друг от<br>
друга, чтоб пользовтаели могли выбирать (однако даже убивание старого сендера<br>
новым клиентом вы пофиксили не сразу).<br>
В общем, позицию можно поменять, но пока SEA остается в состоянии как есть,<br>
без развития &mdash; с нашей стороны точно подвижек не будет.<br>
<br>
<b>Вадим &ndash;&gt; АВТФ:</b><br>
<br>
#Kpot#&gt;Пи#@ёжь и провокация! совсем другое вы год назад говорили<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
в привате значит одно говоришь, на группу другое? мало того, что память<br>
короткая, так еще и грязью поливаем?..<br>
<br>
<b>Крот &ndash;&gt; Вадим, приват:</b><br>
<br>
Насчёт того разговора, вы сказали, что когда посчитаете качество сендера<br>
приемлимым, то можно будет объявить его официальной программой общения сети<br>
автф нет. Это да, но причём тут хостинг. Хостел &mdash; ресурс политеха,<br>
предназначенный для студентов общаги, сендером пользуются студенты общаги, в<br>
чём дело? <br>
<br>
<b>Вадим &ndash;&gt; АВТФ:</b><br>
<br>
#Kpot#&gt;Насчёт того разговора, вы сказали, что когда посчитаете качество<br>
сендера приемлимым, то можно будет объявить его официальной программой<br>
общения сети автф нет. Это да, но причём тут хостинг. Хостел &mdash; ресурс<br>
политеха, предназначенный для студентов общаги, сендером пользуются студенты<br>
общаги, в чём дело? <br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
Хостел выдавался на условиях поддержки совместимости, вы от нее отказались &mdash;<br>
потому и был актуален тот аргумент, что как вернете поддержку, так будет и<br>
хостел. Либо достаточно повысится качество, что можно будет заменить на<br>
официальный и выдать просто по этому факту. С нашей стороны всё логично.<br>
<br>
<b>Вадим &ndash;&gt; АВТФ, отвечая на приватное от Крота:</b><br>
<br>
#Kpot#&gt;Вобщем я иду в деканат и поднимаю тему: администрация сети<br>
отказывается предоставлять ресурсы для сервиса, которым пользуются десятки<br>
студентов общежития. О причинах будете декану объяснять. В письменном<br>
виде<br>
-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-==-<br>
Год назад перед тем разговором мы справлялись в деканате. С нашими<br>
аргументами о недостаточной безопасности и плохом качестве согласились, как и<br>
с тем, что разрабатывать и/или поддерживать должен кто-то из общаги. Можешь<br>
попробовать, конечно, но сомневаюсь, что у тебя получится.<br>
<br>
Unknown end tag for </blockquote><br>
<br>
<br>
<p>Аргумент по безопасности действительно был (см. про возможность взлома в<br>
<a href='#seabugs'>следующем разделе</a>), и администратор YaM_DJ в этом<br>
отношении был непреклонен (актив сети к тому времени SEA-сендером время от<br>
времени уже пользовался, но запускал его под другим пользователем Windows, с<br>
пониженными правами). Впрочем, Крот так и не пошел в деканат, на этом разговоре<br>
всё и закончилось. Однако позже, в середине декабря 2007, nuclight по своей<br>
личной инициативе (пользователи всё-таки страдали почем зря) пошел на<br>
компромиссный вариант: поднял Java-сервер на своем компьютере в общаге.</p>
<p>Так он просуществовал более года, пережив "революцию" в сети весной 2008 и<br>
смену актива.</p>
<p>В сентябре 2008 новым активом SEA Sender был принят как официальное средство<br>
общения пользователей сети, взамен TCPSender. Однако обязать пользователей его<br>
ставить актив не мог, потому что программа мало того что не развивалась и<br>
глючила, так еще и не все возможности были доступны. Вадим Гончаров, хоть и<br>
закончил, всё еще был техконсультантом актива сети. Он связался с Кротом, и тот<br>
возобновил работу архива, переделав старый на работу с MySQL вместо файлов, и<br>
модифицировав сервер. На этот архив можно посмотреть и сейчас по адресу<br>
<a href='http://sea.tomsk.ru/sender/'><a href='http://sea.tomsk.ru/sender/'>http://sea.tomsk.ru/sender/</a></a> &mdash; он<br>
выглядит почти так же, как и в 2006 году. #Kpot# пообещал заняться сендером и<br>
улучшить что-нибудь еще, но это опять-таки кончилось ничем.</p>
<p>Тем временем пользователей в сендере становилось всё меньше и меньше...</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h3>Галерея скриншотов багов SEA Sender:</h3></a>
<p>Здесь собраны скриншоты багов оригинального ("штатного") клиента SEA Sender.<br>
В основном их собирал Семён Тян (Peek), по большей части уже после своего<br>
отключения, но внесли свою лепту и другие пользователи.</p>
<table cellpadding='9' border='1' cellspacing='3'>
<tr valign='top'>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug01.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug01.png' />"<br>
width="147" height="108" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Периодически вот такое он выкидывал, если сервер был не в<br>
той же сети</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug02.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug02.png' />"<br>
width="150" height="124" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Другому человеку в инфе о нас пишет 0.9.2 (см. переписку), а<br>
у нас 0.9.7.4</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug03.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug03.png' />"<br>
width="132" height="126" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Неверный подсчет числа пользователей в списке - симптом более<br>
неприятных багов</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug04.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug04.png' />"<br>
width="132" height="126" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>При неверном подсчете получился пустой пользователь TCPSender</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug05.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug05.png' />"<br>
width="132" height="138" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Повреждения затронули не только пустых пользователей TCPSender<br>
сверху, но и одного юзера SEA сделали выглядящим как юзер TCPSender</p>
</td>
</tr>
<tr valign='top'>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug06.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug06.png' />"<br>
width="152" height="154" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Вместо имен пользователей стали попадаться обрывки сообщений<br>
под видом пользователей TCPSender</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug07.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug07.png' />"<br>
width="147" height="108" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Окно информации о пользователе представляло собой web-страницу,<br>
которая всё никак не могла прогрузиться - а всё было видно</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug08.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug08.png' />"<br>
width="147" height="108" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Такое время от времени вылетало при коннекте к серверу</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug09.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug09.png' />"<br>
width="131" height="124" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Пустые юзеры TCPSender атакуют, тысячи их!</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug10.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug10.png' />"<br>
width="147" height="108" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>И снова вылет ошибки работы с сокетами - заметьте, это третий<br>
раз, и все 3 - разные ошибки</p>
</td>
</tr>
<tr valign='top'>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug11.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug11.png' />"<br>
width="147" height="108" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Явная ошибка в имени пользователи - и инфу показывает тоже о<br>
ком-то другом</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug12.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug12.png' />"<br>
width="133" height="54" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Если в предыдущих таких багах можно было нажать "пропустить",<br>
и с высокой вероятностью работа продолжалась - тут ничего сделать уже нельзя</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug13.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug13.png' />"<br>
width="147" height="107" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>В чат позвонил человек-невидимка. Или дзен-буддист</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug14.png' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seabug14.png' />"<br>
width="147" height="85" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Снова "сиреневые человечки", но на этот раз в строке состояния<br>
пусто</p>
</td>
<td border='1'>
<a></a><a target="<i>blank"<br>
href="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seasender-bug-080424.gif' />"><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/seasender-bug-080424.gif' />"<br>
width="142" height="98" align="center" alt="" title=""><br>
<br>
Unknown end tag for </a><br>
<br>
<br></i><p>Иногда окно ввода сообщения вдруг переключалось вот в такой<br>
режим, где всё справа налево. Наверное, это секретный сендер для арабских<br>
террористов</p>
</td></tr></table>
<p>В скриншоты, правда, не попал еще один баг, обнаруженный еще Мишаней в<br>
ноябре 2006. Тогда ему не придали большого значения и не зафиксировали, хотя<br>
позже оказалось, что он серьезнее вышеперечисленных. Мишаня тогда игрался с<br>
чатом, и при определенных условиях добивался весьма неожиданных эффектов.<br>
Больше внимания он обращал на сервер (тот мог начать тормозить с передачей<br>
сообщений, например), а стоило именно на клиент.</p>
<p>Заключался он в том, что при определенном вводе в чат в общем окне строк<br>
чата могло вывалиться совершенно не то, что ввёл пользователь, а куча букв M на<br>
много экранов. Как было выяснено много позже, это &mdash; симптом переполнения<br>
буфера. В программах на Си такое встречается при ошибках работы с памятью. Вот<br>
только этот баг отнюдь не безобиден &mdash; переполнение буфера любят использовать<br>
хакеры для удаленного исполнения кода. То есть, это &mdash; самая настоящая<br>
уязвимость, которую можно использовать для взлома машин пользователей и<br>
получения над ними полного контроля &mdash; учитывая, сендер часто любят запускать с<br>
админскими правами... Общагу спасло только то, что настолько серьезных хакеров<br>
у нас не было (хотя в Томске были), никто не заинтересовался. Впрочем, если<br>
вспомнить случай с Muzzy, кто знает, в самом деле ли?..</p>
<p>Точного способа воспроизведения бага не осталось, кроме неполного описания<br>
&laquo;Пользователь В посылает в уже открытое окно большую строку (по идее не<br>
превышающую 127)&raquo;. По всей видимости, баг связан с тем, что клиент<br>
трактует числа, приходящие из сети, как знаковые, а не беззнаковые.</p>
<p>Остается только напомнить, что админское чутье не подвело актив сети в том<br>
разговоре в начале октября 2006. Увы, тогда такой информации не было, и актив<br>
в результате поступил весьма либерально, разрешая пользоваться сендером тем,<br>
кто этого хочет: в отношении заплаток к винде (не всех, а тех, что черви<br>
использовали для распространения по сети) политика была более жесткая &mdash;<br>
отключение от сети до исправления проблемы.</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h2>Настоящее время</h2></a>
<p>В мае 2009 пользователей в сендере оставалось всего лишь около 30 человек.</p>
<p>Совсем мало, особенно если учесть, что сеть с тех пор выросла в 2 раза, а<br>
в сендере тогда сидело под сотню человек. Актив сети такое положение не<br>
устраивало &mdash; сендер был удобен, например, для вывешивания объявлений активом,<br>
но получалось, что мало кто мог их прочитать.</p>
<table align='right' border='0'><tr valign='top'><td width='268' height='116'>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/blast-trayinfo.png' />"<br>
width="268" height="116" align="center" alt="" alt="BlastCore - двойной щелчок<br>
по иконке в трее"></a></td></tr>
<tr><td><p>Двойной щелчок по иконке BlastCore в трее</p>
</td></tr></table>
<p>Новый администратор сети Михаил Шеховцов (Knauer) обсудил этот вопрос с Вадимом<br>
Гончаровым (nuclight), техническим консультантом сети, когда последний<br>
поинтересовался возможностью забрать свою машину из общаги через несколько<br>
месяцев (на тот момент она использовалась почти только для хостинга сервера).<br>
Решили, что сервер надо переписать на Си, чтобы он мог работать на хостеле (с<br>
того к тому времени давно уже снесли Java), и чтоб не глючил. 22 мая nuclight<br>
занялся этим в свободное время, а когда сервер был готов к началу тестирования,<br>
12 августа 2009 ему пришла в голову мысль, что можно ведь привлечь и Семёна,<br>
доделать когда-то созданный им BlastCore, на замену старому штатному клиенту.</p>
<p>И вот, по старому знакомству, они незамедлительно развернули работу, возродив<br>
канал #SEASender в IRC-сети RusNet.</p>
<p>Разработка была организована на современном уровне. Был зарегистрирован<br>
проект на <a href='http://code.google.com/p/blastcore/'><a href='http://code.google.com/p/blastcore/'>http://code.google.com/p/blastcore/</a></a>,<br>
с использованием системы контроля версий SVN (каждое изменение в коде фиксируется<br>
системой, можно отслеживать, что именно привело к тому или иному багу, откатывать<br>
его, и т.д.). Исходники, в отличие от всех предыдущих сендеров, публично<br>
доступны, любой желающий может получить с сайта версию BlastCore на любой<br>
момент в прошлом (под Windows это можно сделать с помощью<br>
<a href='http://tortoisesvn.net/'>TortoiseSVN</a>).</p>
<p>Администрация сети, однако, заинтересована в том, чтобы не остаться без<br>
разработчиков и использовать все возможности &mdash; конкуренция будет на благо<br>
пользователям. Поэтому актив сети связался и с Алексеем Фадеевым (#Kpot#), но<br>
тот ответил, что один продолжать разрабатывать SEA Sender не будет, и отдал<br>
исходные тексты клиента и сервера &mdash; дабы желающие могли продолжить. Впрочем, он<br>
сказал, что у него есть кое-какие идеи о том, как можно было бы сделать сендер<br>
лучше, написав заново, что вполне потянет для кого-нибудь на дипломную работу &mdash;<br>
но оформит эти идеи в письменном виде он попозже.</p>
<p>Что ж, тоже результат &mdash; эти исходники помогли уточнить некоторые туманные<br>
моменты в реализации, неочевидные из перехвата протокола.</p>
<p>И вот, 13 сентября 2009 года, в День Программиста, публично был анонсирован<br>
BlastCore 0.2 beta, умевший полный набор фич штатного клиента SEA Sender (за<br>
исключением <a href='#img-tcps-chat'>кнопки "звонка"</a> для той стороны во<br>
время установленного чата), и ряд интересных решений сверх того.</p>
<p>Например, добавилось обрезание цитат: раньше при активной переписке (ведь<br>
добавляются слова после цитаты) весь текст переставал влезать в окно, нужно<br>
было проматывать. Теперь сендер автоматически обрезал самые старые цитаты,<br>
заменяя их на многоточие (пользователю это было делать лениво).</p>
<p>Через 10 дней вышла версия 0.21 beta, которая содержала только исправления<br>
ошибок и незначительные косметические правки. Вот так она выглядела:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/blast-main.png' />"<br>
width="660" height="572" align="center" alt="" title=""></a>
<p>Здесь первое, что бросается в глаза: выпадающий список сообщений был заменен<br>
на панель внизу окна, где сообщения стало можно выделять галочками (помечаются<br>
и сами при прочтении сообщения) для дальнейшего удаления только выделенных<br>
новой кнопкой удаления. При желании панель можно скрыть совсем, щелкнув по<br>
разделителю &mdash; информация пишется и на привычном месте вверху (но теперь её<br>
стало можно выделить и скопировать). Панель, кроме того, показывает длину<br>
сообщения и некоторую техническую информацию &mdash; ID отправителя, флаг того, что<br>
адресовано печатникам.</p>
<p>Из менее заметных изменений можно отметить подсветку ссылок в тексте (и<br>
если щелкнуть, то откроется в браузере), иконка над сообщением снова, как и в<br>
TCPSender, показывает, приватное оно или групповое, добавлены кнопки на<br>
панели инструментов для быстрой "перемотки" в начало и конец списка, а также<br>
удаления всех сообщений.</p>
<p>Полезные изменения коснулись и системного трея: теперь контекстное меню там<br>
содержит некоторые частоиспользуемые функции &mdash; например, отключить звуки на<br>
ночь (или встать в away) можно без раскрытия окна и залезания в опции. Еще<br>
BlastCore стал уметь показывать и сами сообщения в трее без разворачивания<br>
окна, как современные клиенты ICQ:</p>
<table cellpadding='10' border='0' cellspacing='5'><tr valign='top'>
<td>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/blast-traymenu.png' />"<br>
width="326" height="181" align="center" alt="" title=""></a>
<p>Предыдущие сендеры имели только один пункт: "Выход"</p>
</td><td>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/blast-traymsg.png' />"<br>
width="423" height="153" align="center" alt="" title=""></a>
<p>Показ сообщения в "Balloon Hint" сразу, как только оно пришло.<br>
<br>Предыдущие сендеры умели только развернуть окно целиком, что гораздо менее<br>
удобно<br>
<br>
Unknown end tag for </p><br>
<br>
<br>
<br>
<br>
Unknown end tag for </td><br>
<br>
<br>
<br>
Unknown end tag for </tr><br>
<br>
<br>
<br>
Unknown end tag for </table><br>
<br>
<br>
<p>После выхода 0.21 beta разработка несколько замедлилась, потому что набор<br>
возможностей уже был больше чем у штатного клиента, а надо было переключиться<br>
на другие насущные задачи. Так, нужен был нормально работающий архив. Peek<br>
поднял свои архивы, как утянутые во время взлома, так и те, что велись его<br>
собственной программой в 2007. Екатерина Блеч (Ketra) написала новую версию<br>
Web-архива, сначала с той же функциональностью, что и в оригинале, а к декабрю<br>
доработала её до более удобных возможностей: появилась возможность поиска по<br>
архиву и показ произвольного числа сообщений между любыми двумя датами, в любом<br>
порядке сортировки.</p>
<p>Пользователи после тестирования были переведены на новый сервер, который<br>
написал nuclight и который был модифицирован для более гибкой отдачи сообщений<br>
в архив. Теперь все старые глюки исчезли, а все архивы были импортированы в<br>
новый, располагающийся на сервере общежития. В BlastCore тем временем появились<br>
некоторые новые мелкие фичи, а также поддержка скинов и настроек шрифтов текста<br>
сообщений. Авторами была задумана возможность отправлять форматированный текст,<br>
а также со временем сделать и давно просимую пользователями возможность<br>
передачи файлов &mdash; правда, протокол SEA Sender позволяет реализовать её только<br>
в ограниченном виде. Но об этом в <a href='#seashit'>следующем разделе</a>.</p>
<p>К сожалению, в 2010 году дела у BlastCore Sender пошли гораздо хуже. Семён<br>
Тян почти совсем забросил разработку, и версия 0.4, ожидавшаяся изначально в<br>
январе, была отложена сначала до апреля, а потом и до нового учебного года.<br>
Виной тому послужил в основном испортившийся характер самого Peek &mdash; хотя он<br>
дал обещание выпустить версию 0.4 к сентябрю, срок затянулся сначала до<br>
середины месяца. А потом Семён и вовсе подвел народ (готовность должна была<br>
быть к началу подключения новых пользователей), бросил всё и ушел, когда<br>
оставалось совсем чуть-чуть. Евгению Родионову (rodya), автору инсталляторов<br>
всех версий BlastCore, пришлось вносить последние правки в условиях жесткой<br>
нехватки времени &mdash; был конец сентября, навалилась и учеба, и подключение новых<br>
пользователей.</p>
<p>Сейчас версия 0.4 поддерживает прием форматированного текста (полужирный,<br>
цветной и т.д.), поддерживает смайлики, умеет проверять наличие обновлений &mdash; но<br>
вот будущее этих обновлений теперь весьма туманно. Впрочем, на этот раз все<br>
исходники открыты, и разработку может продолжить любой желающий.</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h2>Недостатки SEA Sender с точки зрения программиста</h2></a>
<p>Этот раздел предназначен для тех, кто хочет разобраться в вещах, сходу<br>
неочевидных и пользователю невидимых, но, тем не менее, влияющих на то, что<br>
пользователь может или не может получить от программы. Речь идет об<br>
<i>архитектуре</i> проекта, в сетевых системах наиболее важной частью которой<br>
является <i>протокол</i> взаимодействия (обычно между клиентом и сервером).<br>
Когда пользователь просит добавить галку в опции или сменить звук, это автор<br>
может сделать легко. Но когда пользователь просит сделать передачу файлов, или,<br>
скажем, уведомление, что та сторона в чате "Сейчас печатает" &mdash; автор неожиданно<br>
сталкивается с тем, что это очень трудно, если вообще возможно. Потому что было<br>
<i>не предусмотрено</i> в протоколе. Для этого оказывается нужным переделать<br>
чуть ли не всю систему. Ну, как в свое время TCPSender не мог работать за<br>
NAT, например &mdash; пришлось менять архитектуру на клиент-серверную, а с ней и<br>
протокол.</p>
<p>Вот именно об ошибках <i>проектирования</i> SEA Sender и пойдет главным<br>
образом здесь речь, хотя будут затронуты и вопросы реализации сервера.</p>
<p>Почему более важен протокол, а не реализация? Потому что именно он<br>
определяет реализацию, а не наоборот.</p>
<p>Помните, как сказал классик?</p>
<blockquote>&laquo;Покажите мне свой код и спрячьте структуры данных &mdash; и я останусь<br>
одураченным. Покажите мне свои структуры данных, и мне, скорее всего, не<br>
понадобится ваш код, он будет очевидным.&raquo;<br>(Ф. Брукс, &laquo;Мифический<br>
человеко-месяц&raquo;, гл.9)<br>
<br>
Unknown end tag for </blockquote><br>
<br>
<br>
<p>Но это было сказано для программы, в случае же с протоколами всё еще хуже:<br>
протокол нельзя поменять так просто, как программный код, потому что придется<br>
менять <i>все</i> реализации в сети сразу &mdash; что очень сложно даже при наличии<br>
контроля над ними, не говоря уже о реальном мире, где приходится поддерживать<br>
совместимость со старыми версиями.</p>
<p>На самом деле, проблема этой распространенной ошибки в том, что люди<br>
<a href='http://www.joelonsoftware.com/articles/fog0000000036.html'>думают,<br>
будто бы на проектирование не стоит тратить время &mdash; но ошибочность этой<br>
позиции выявляется гораздо позже, когда приходится менять в коде гораздо<br>
больше, а итоговое качество его при этом всё равно страдает</a>. В конце<br>
концов, среди провалившихся проектов гораздо больше тех, которые не уделили<br>
должное внимание проектированию, архитектуре и написанию спецификаций, чем<br>
среди тех, в которых таки уделили.</p>
<p>Но вернемся к SEA Sender. Для понимания дальнейшего текста нужно будет<br>
держать перед глазами две графические иллюстрации протокола: это команды<br>
<a href='http://seasrvkq.googlecode.com/files/seaproto_c2s.png'>от клиента серверу</a> и<br>
<a href='http://seasrvkq.googlecode.com/files/seaproto_s2c.png'>от сервера клиенту</a>. Их<br>
подготовил Семён Тян (Peek) во время работы по перехвату данных между клиентом<br>
и сервером SEA Sender, тем же методом реверс-инжиниринга, что писались и<br>
альтернативные клиенты ICQ.</p>
<p>На картинке не подписано, но все числа длиннее одного байта передаются в<br>
так называемом сетевом порядке байт &mdash; от старшего к младшему. Это верное<br>
решение: в архитектуре x86 числа хранятся в обратном порядке (<a<br>
href="<a href='http://ru.wikipedia.org/wiki/Little-endian'>http://ru.wikipedia.org/wiki/Little-endian</a>">little-endian<br>
<br>
Unknown end tag for </a><br>
<br>
), и для<br>
обработки машиной их нужно конвертировать. Неопытные программисты часто пишут<br>
числа в сеть как есть, в результате система неожиданно откажется работать на<br>
ряде других аппаратных платформ (Macintosh/PowerPC, мобильные устройства, ряд<br>
других). Здесь эта ошибка не допущена.</p>
<p>Но вот дальше начинаются, как говорят зарубежные коллеги, idiosyncrasies.</p>
<p><b>Три байта.</b> Для конвертации 16-битных (<b>s</b>hort) и 32-битных<br>
(<b>l</b>ong) значений существуют стандартные функции <tt>htons()</tt>,<br>
<tt>htonl()</tt> для <b>h</b>ost to <b>n</b>etwork, и <tt>ntohs()</tt>,<br>
<tt>ntohl()</tt> для <b>n</b>etwork to <b>h</b>ost. В протоколе же SEA Sender<br>
для длины пакета используется нестандартное, 3-байтное значение. В результате<br>
в реализации необходимо писать свои собственные функции. Более того, столько<br>
и не нужно &mdash; во всех остальных местах протокола используются 16-битные<br>
значения, и длина команды в худшем случае превысит 65535 лишь на 7 байт (но<br>
заголовок можно и не считать).</p>
<p>Еще смешнее становится, если заглянуть в исходники сервера и клиента<br>
SEA Sender: функция <tt>lenintto3bytes()</tt> (и аналог в обратную сторону)<br>
повсеместно используется <i>вместо</i> <tt>htons()</tt>, с дополнительным<br>
кодом по игнорированию старшего третьего байта &mdash; похоже, авторы просто не знали<br>
о существовании стандартных функций.</p>
<p><b>Расширяемость: длина команды от сервера.</b> Можно видеть, что клиент<br>
сначала пишет полную длину команды, потом идет она сама. Таким образом, сервер<br>
читает её целиком, потом может обрабатывать. А вот в обратном направлении, от<br>
сервера к клиенту &mdash; никакой общей длины команды не пишется. В итоге становится<br>
невозможно ввести в протокол новые команды, не обучив им клиент: он читает один<br>
байт команды и по нему определяет, когда начнется следующая. В случае, когда<br>
номер команды неизвестен, то клиент не знает, какой она длины, и где начнется<br>
следующая.</p>
<p>Если бы сервер писал полную длину команды перед ней, то клиент мог бы<br>
просто игнорировать неизвестные ему команды. Очевидно, что подход "не писать<br>
клиенту длину" немного проще для сервера в реализации &mdash; её не нужно заранее<br>
высчитывать. Зато это оборачивается гораздо бОльшим количеством кода потом,<br>
когда для каждой новой команды серверу приходится проверять версию клиента &mdash;<br>
поймет ли он её.</p>
<p>Кроме того, полезным было бы добавление <i>сигнатуры</i> в команды &mdash;<br>
несколько байт, которые должны равняться строго определенному значению ("magic<br>
number"). Клиент и сервер могли бы проверять их в начале каждой команда, тогда<br>
ошибки рассинхронизации (типа <a href='#img-seabug06'>вот этой</a>) были бы<br>
сразу обнаружены.</p>
<p><b>Неконсистентность представления IP-адреса.</b> В командах #1 и #6 от<br>
сервера идет байт длины, затем IP-адрес в <i>текстовом</i> виде. Тогда как<br>
его всегда можно представить как 4 байта, что и сделано в команде #13. К тому<br>
же, чтение адреса из сети в текстовом виде (обработка байта длины) &mdash; это<br>
дополнительный код, без которого можно было бы обойтись.</p>
<p><b>Неоптимальный формат команд.</b> Этот пункт обусловлен двумя<br>
предыдущими &mdash; отсутствием поля общей длины. В результате в командах нужны свои<br>
собственные поля длин, причем в случае передачи от клиента серверу &mdash; они<br>
фактически бессмысленно дублируются. А нередко и просто излишне ограничивают.<br>
Например, команды чата #7 или получения URL архива #9 &mdash; ограничены 256 байт (а<br>
на самом деле 127 из-за багов клиента).</p>
<p>Кроме того, расположение полей часто заставляет писать дополнительный код<br>
по обработке. Например, для чтения ответа на запрос информации о пользователе<br>
(#6) клиенту нужно:</p>
<ul>
</blockquote><blockquote><li>прочитать байт #6</li>
<li>прочитать 7 байта: факультет, комната, байт длины Info</li>
<li>прочитать n байт Info</li>
<li>прочитать байт версии и байт длины IP-адреса</li>
<li>прочитать n байт IP-адреса</li>
</ul>
<p>Если IP-адрес представить в двоичном виде, сократится только один шаг. Но<br>
если бы было общее поле длины, а байты версии и адреса поставить <i>до</i>
кусков переменной длины, а не после, осталось бы всего 2 шага:</p>
<ul>
<li>прочитать байт #6 и общее поле длины</li>
<li>прочитать n байт тела команды, выделить фиксированные части, остаток же до<br>
конца команды &mdash; будет полем Info</li>
</ul>
<p><b>TCPSender: диапазон ID.</b> При входе клиента (команда #1 от сервера)<br>
клиент получает списки пользователей SEA Sender и TCPSender раздельно. Это<br>
нормально. А вот в команде #2 никак не указано, кто вошел в сеть. В какой из<br>
двух списков его добавить? В результате в реализации был искусственно выбран<br>
диапазон ID 1000-2000 для пользователей TCPSender &mdash; клиент различает их по<br>
номеру. Это означает, что более 1000 клиентов SEA держать не получится. Число<br>
может показаться достаточно большим, но на самом деле оно зависит от способа<br>
выдачи нового ID на сервере. Счетчик может быть гораздо больше реального числа<br>
пользователей (из соображений уникальности, например) &mdash; и это действительно<br>
происходило. Ряд <a href='#img-seabug04'>багов</a> <a href='#img-seabug09'>с<br>
"сиреневыми</a> <a href='#img-seabug14'>человечками"</a> был вызван в том<br>
числе и этим.</p>
<p><b>TCPSender: сообщения, шлюзование.</b> Поддержка TCPSender реализована<br>
плохо, без учета последствий. Даже после отключения &mdash; она всё равно намертво<br>
зашита в протоколе. Например, при получении сообщения, после полного его<br>
чтения, снова идёт один байт длины, потом имя пользователя, снова байт длины,<br>
имя машины. Но только, если ID отправителя был нулевым. Растет это, видимо, из<br>
каких-то проблем при поддержке TCPSender &mdash; послать такое мог только сервер. А<br>
обрабатывать дополнительный ноль приходится и по сей день.</p>
<p>Вообще, поддержка старого сендера должна была быть сделана совершенно иначе.<br>
Нужно было написать <i>шлюз</i> &mdash; специальный модуль, понимающий оба протокола<br>
и осуществляющий конвертацию между ними. А клиент и сервер умели бы сугубо<br>
свой, чистый протокол. Так поступают, например, в мире Jabber. И после<br>
отключения поддержки TCPSender не пришлось бы тащить за собой заглушки в коде.<br>
Которые и по сей день негативно влияют на возможность расширения протокола...</p>
<p><b>Печатники.</b> Удивительное дело, но сообщение группе "Печатники"<br>
считается приватным &mdash; у него стоит соответствующий флаг. Можно предположить,<br>
почему, но всё равно остаться в недоумении: допустим, это не поняли бы старые<br>
клиенты (что не умели печатников). Но ведь старый клиент и не сможет войти в<br>
группу печатников и получать такие сообщения!</p>
<p>Это еще не всё. Вроде бы, вполне достаточно ID получателя 65535, чтобы<br>
понять: ага, это для печатников сообщение. Но нет, предусмотрительно<br>
зарезервированное поле, целых два байта в заголовке сообщения, отводятся под<br>
специальный флаг! Именно два: сервер выставляет <b>каждый</b> из них. Хотя<br>
клиент проверяет только один из них (хуже того, BlastCore проверяет другой из<br>
них, чем штатный клиент). Такая проверка резко снижает дальнейшую возможность<br>
расширения протокола.</p>
<p><b>Расширяемость: Away.</b> Казалось бы, как можно намудрить с такой<br>
простой командой, как войти/выйти из away? Но и здесь есть свои недоделки.<br>
Away был введён довольно поздно. Старые клиенты не понимали бы такую команду.<br>
Поэтому сервер после получения информации о пользователе, убедившись, что<br>
клиент поддерживает, шлет ему ряд команд away &mdash; как будто бы эти пользователи<br>
встали в away только что. Правильным решением было бы иметь расширяемый<br>
формат списка пользователей (а заодно и информации об одном пользователе), где<br>
и выставлять этот флаг.</p>
<p><b>Чат.</b> Что здесь может плохого? Ну, про ограничение длины уже выше<br>
говорилось. Однако реализован чат и в других местах <s>через жо</s> своеобразно.<br>
Клиент не хранит состояние &mdash; оно определяется открытыми сейчас формами. В<br>
результате используется <b>четыре</b> команды-запроса #7 для установления вместо<br>
двух, и три #8 вместо одной. Сначала инициатор (И) посылает #7, у получателя<br>
(П) высвечивается окно "Хотите ответить? Да/Нет". Если да, то П отвечает<br>
пустым #7 как подтверждением, И создает окно чата и <b>еще раз</b> шлет #7. В ответ<br>
на получение такого #7 П создает своё окно чата и тоже шлёт пустой #7. Всё,<br>
чат установлен, теперь #7 идет непустой, с текстом.</p>
<p>Если текст специальный, "<tt>//beep//</tt>" &mdash; то на той стороне прозвенит<br>
звонок. Этот подход был бездумно скопирован из протокола TCPSender, хотя лучше<br>
было б использовать какое специальное значение, которое невозможно набрать с<br>
клавиатуры. А заодно и возможность "сейчас печатает" приделать, как в аське,<br>
раз уж спецкоманда.</p>
<p>Закрывается чат пустыми #8: на команду юзера просто посылается #8, а на<br>
прием #8 &mdash; закрывается окно у нас и отсылается #8. То есть, сначала тот, кто<br>
хочет закрыть, шлет #8, ему приходит ответный #8, который закроет ему окно;<br>
при закрытии своего окна он отправит #8, который та сторона уже<br>
проигнорирует.</p>
<p>Заморочено, да? А для версий до 0.9.4 было еще хуже.</p>
<p><b>Версии и строки.</b> Вообще, в версиях до 0.9.6 даже такая команда mute<br>
обрабатывалась по-другому. Представление самих версий тоже оставляет желать<br>
лучшего. И для 0.9.7, и для 0.9.7.4 получается одна и та же &mdash; 97. Фактически,<br>
это версия протокола, которая нужна серверу. А человеку можно было бы показывать<br>
и строкой &mdash; заодно позволив и другие варианты, не только SEA Sender.</p>
<p>Впрочем, константные строки применялись и в других местах. Например, в код<br>
клиента жестко вшиты названия "АВТФ" и "МСФ" для номеров факультетов 1 и 2 в<br>
юзеринфе, соответственно. Это сразу ограничивает применение сендера только<br>
конкретными общежитиями (TCPSender мог использовать кто угодно). Но даже и тут:<br>
вот сейчас идет реорганизация ТПУ и переименование факультетов в институты. И<br>
всё, старая схема больше не годится...</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h3>Проблемы реализации</h3></a>
<p>Всё вышеперечисленное относилось к проблемам протокола/архитектуры &mdash; то есть<br>
к таким вещам, которые не могут быть исправлены простым переписыванием кода.<br>
Ниже речь пойдет о тех проблемах, которые такому исправлению поддаются, и в<br>
<a href='#blastcore'>переписанном в 2009 году</a> сервере действительно были<br>
поправлены.</p>
<div><b>Декомпилированный сервер, ноябрь 2006</b>
<pre><b>Строк     Байт Файл<br>
<br>
Unknown end tag for </b><br>
<br>
<br>
66     1493 DisconnectSender.java<br>
66     2009 Listener.java<br>
49     1273 PhpListener.java<br>
48     1159 ScanAnswerer.java<br>
116     3170 ScanAnswerer2.java<br>
50     1187 Scaner.java<br>
75     1893 Scaner2.java<br>
242     6298 ServSender.java<br>
166     4445 TCPSender.java<br>
95     2711 TSAdder.java<br>
39      946 TSMsgAnswerer.java<br>
131     3509 TSMsgAnswerer2.java<br>
62     1431 TSUser.java<br>
236     6736 Tools.java<br>
84     1984 User.java<br>
656    25673 Worker.java<br>
2181    65917 Всего</pre></div>
<p>Оригинальный сервер состоял из 16 классов на Java, хотя в отданных в 2009<br>
году исходниках присутствует только 11 файлов <tt>.java</tt> (однако есть все<br>
16 бинарных <tt>.class</tt>). Поскольку исходники были получены не сразу, а<br>
пограничные случаи типа изменения формата команды в зависимости от версии<br>
клиента по одному лишь перехвату данных не сделать, то в августе 2009 года был<br>
разыскан декомпилятор Java-кода, и использована та версия, что Peek утащил при<br>
взломе.</p>
<p>Сам же новый сервер был написан на чистом Си, одним файлом, 2600 строк, 86<br>
Кб. С промежуточной версией на начало сентября 2009 можно ознакомиться <a<br>
href="/~vadim/sender/seasrvkq.c.html">здесь<br>
<br>
Unknown end tag for </a><br>
<br>
 (впоследствии сервер, как и<br>
BlastCore, стал располагаться на <a<br>
href="<a href='http://code.google.com/hosting/search?q=label:SEA-protocol'>http://code.google.com/hosting/search?q=label:SEA-protocol</a>">Google<br>
Code<br>
<br>
Unknown end tag for </a><br>
<br>
).</p>
<p>Начат он был вечером 22 мая 2009, писался в свободное время, которое<br>
тщательно замерялось, и заняло 46 часов 12 минут на написание до первого<br>
запуска, затем еще 29:20 было потрачен на отладку, до введения его в строй<br>
основным сервером.</p>
<p>Код обильно снабжен комментариями (в отличие от оригинального сервера), в<br>
блоках с пометкой <tt>SEA SHIT</tt> подробно описаны те проблемы SEA Sender,<br>
которые надо было решать. Часть из них уже была описана выше &mdash; это проблемы<br>
протокола. Остальное же &mdash; ошибки оригинального Java-сервера</p>
<p>И проблемы начинаются сразу же, с процедуры <b>логина пользователя.</b> В сервере<br>
не была предусмотрена корректная процедура сообщения пользователю, что он себе<br>
в настройках ввёл некорректный ник. Ну, например, что там символы HTML<br>
<tt>&lt;</tt> и <tt>&gt;</tt> (помните порнуху в архиве?). Зато сервер молча<br>
убивал пользователя, если ник начинался с пробела. Это явно было сделано<br>
сугубо против <a href='#seavtfnet'>выходок Мишани</a>, но пришлось сохранить<br>
и в новом сервере &mdash; потому что иначе сбивалась сортировка в штатном клиенте.<br>
А раз нельзя пользователю отказать во входе, придется заменять символы в нике.<br>
Поэтому выделена функция <tt>escape_name()</tt> (при правильной архитектуре<br>
вообще была бы не нужна), которая заодно проверяет на дополнительные ошибки,<br>
типа символов перевода строки или вообще чего-нибудь управляющего. Она же<br>
применяется при обработке смены ника пользователем на лету &mdash; вот там<br>
оригинальный сервер не делал проверок даже на пробел!</p>
<p>Раз уж речь зашла об эскейпинге имен, которая изначально делалась для<br>
<b>архива</b>, надо сразу сказать и о реализации архива. Изначально Java-сервер<br>
просто открывал файл с именем типа 18_11_2006.php и дописывал туда сообщение.<br>
В 2008 Крот сделал схему более корректной: сервер стал соединяться с MySQL-базой,<br>
что позволило держать архив и сервер на разных машинах &mdash; а заодно и решило бы<br>
проблему отсутствия в архиве сообщений с альтернативного сервера. Однако и это<br>
не лучшее решение. Лучшим было бы, если б протокол поддерживал получение старых<br>
сообщений собственными средствами (как оффлайновые в ICQ), но это решаемо<br>
только <a href='#thsender'>совсем другим протоколом</a>.</p>
<p>Здесь же остается только сделать архив модульным: с базой, или что там еще,<br>
общается отдельный процесс, он пусть и занимается эскейпингом и всем прочим.<br>
Сервер же на Си просто пишет в поток сообщения, очень простым микропротоколом.<br>
Решение в лучших традициях Unix: этот поток можно направить вообще не в процесс,<br>
а в файл, позже же просто подать файл на вход процессу-обработчику. Так можно<br>
обеспечить и бОльшую надежность при недоступности архива...</p>
<p>Но вернемся ко <b>входу пользователя на сервер.</b> Первой командой должна<br>
быть строго определенная: #1, с ником и машиной. И сервер ожидал первой именно<br>
её. Но если первой была не она &mdash; сервер ничего не делал, коннект просто<br>
оставался висеть открытым. Так можно и ресурсы сервера исчерпать при желании.<br>
Не проверял он, и если такая команда поступит в середине сессии &mdash; хотя и не<br>
ответит.</p>
<p>Зато в коде предпринимаются специальные меры, чтобы вновь вошедшему<br>
клиенту в списке всех пользователей отдать информацию о нем самом &mdash; самым<br>
первым в этом списке. Этому посвящены от 20 до 50 строк Java-кода, смотря как<br>
считать. Вероятно, это имеет какую-то особую важность для клиента (или просто<br>
обход бага), но на всякий случай было повторено и в Си-сервере. Только уже<br>
двумя строчками (13 на весь кусок), а не портянкой на несколько экранов &mdash;<br>
элегантными макросами <tt>LIST_INSERT_HEAD</tt> и <tt>LIST_FOREACH</tt>.</p>
<p>Вообще, несмотря на богатство инструментария Java, работа со связными<br>
списками в оригинальном сервере осуществлена из рук вон плохо. Вот типичный<br>
кусок обработки списка пользователей, который повторяется во многих местах<br>
(здесь он используется для отправки массива байт <tt>b</tt>):</p>
<blockquote><pre>while(!user.server.sourcelistfree)<br>
try<br>
{<br>
sleep(50L);<br>
}<br>
catch(Exception ex) { }<br>
user.server.sourcelistfree = false;<br>
int cnt = user.server.Usercnt();<br>
int j = 0;<br>
User userlist[] = new User[cnt];<br>
for(User usr = user.server.last; usr != null; usr = usr.prev)<br>
{<br>
userlist[j] = usr;<br>
j++;<br>
}<br>
<br>
user.server.sourcelistfree = true;<br>
OutputStream os = user.sock.getOutputStream();<br>
for(j = 0; j < cnt; j++)<br>
if(userlist[j] != user && userlist[j].away && user.vers >= 96)<br>
{<br>
b = Tools.lenintto3bytes(userlist[j].id);<br>
b[0] = 11;<br>
os.write(b);<br>
}</pre></blockquote>
<p>Это фееричные 25 строк, шедевр, достойный<br>
<a href='http://govnokod.ru/'>govnokod.ru</a>! И хрен бы еще с ним, со связным<br>
списком, а вот мимо ошибок синхронизации пройти нельзя.</p>
<p>Обратите внимание на переменную <tt>sourcelistfree</tt>. Это флаг<br>
использования списка пользователей: если он используется другой нитью (thread),<br>
то наша &mdash; ждёт освобождения. Потом взводит сама (чтоб теперь другие не<br>
использовали), копирует список во временный массив, отпускает общий список и<br>
работает с копией.</p>
<p>Проблема с этим кодом описывается в любом курсе по операционным системам:<br>
это классический race condition. Если другая нить сделает ту же проверку<br>
<tt>while(!user.server.sourcelistfree)</tt> в промежутке между нашей<br>
проверкой и присвоением <tt>user.server.sourcelistfree = false</tt> &mdash; то<br>
доступ получат сразу две нити. Кроме того, нить работает с <i>копией</i>
списка &mdash; и если за это время он изменился (вошел или вышел пользователь),<br>
то результат снова будет неверен.</p>
<p>Ясно, что архитектура сервера "по одному треду на клиента" была выбрана,<br>
потому что так проще работать с сокетами. Но корректное программирование<br>
многопоточных приложений при наличии общих данных &mdash; задача уже отнюдь не<br>
простая. Даже при использовании корректных <tt>атомарных</tt> средств<br>
синхронизации тредов в сложных приложениях бывают разнообразные ошибки<br>
программирования (deadlock'и и т.д.), что уж говорить об их отсутствии.</p>
<p>Именно этой проблемой и были вызваны проявлявшиеся в непредсказуемые<br>
случайные моменты ошибки с отправлением сообщений от имени не того<br>
пользователя и длительные задержки доставки.</p>
<p>Сервер на Си (seasrvkqd) был построен по другой архитектуре: как<br>
конечный автомат (FSM, Finite State Machine). Здесь только один тред, а<br>
управляется всё получением событий на сокетах от операционной системы:<br>
ОС FreeBSD предоставляет здесь очень удобный механизм <tt>kqueue()</tt>.<br>
Блоки комментариев в коде с пометкой <tt>KQ FEATURE</tt> описывают его<br>
возможности.</p>
<p>Такую же самую архитектуру с тем же самым системным вызовом <tt>kqueue()</tt>
использует, например, известный высокопроизводительный Web-сервер nginx,<br>
автор которого демонстрировал 100 000 (сто тысяч!) одновременных соединений.<br>
Наверное, не стоит добавлять, что сервер работает очень стабильно, почти не<br>
потребляя процессорного времени.</p>
<p>Отдельно надо сказать о <b>пингах</b>, раз уж зашла речь о ресурсах. Во<br>
всех клиент-серверных системах с длительным постоянным соединением сервер<br>
периодически отправляет клиенту "пинг", специальную пустую команду, просто для<br>
проверки живости соединения. Зачем это делается? Для того, чтобы клиент не<br>
занимал ресурсы сервера, а в системах типа сендера/IRC/ICQ &mdash; также для того,<br>
чтобы остальные клиенты узнали, что этот уже "отвалился". Причем природа сетей<br>
такова, что TCP-соединение, если по нему не ходят данные, может висеть<br>
неделями. Можно установить коннект, не слать по нему данные и выдернуть кабель<br>
из промежуточного маршрутизатора. Соединение останется активно. Придти через<br>
день, воткнуть, что-нибудь отправить &mdash; оно оживет, данные побегут как ни в чем<br>
не бывало. Но если потеря связи начнется во время передачи (отправить, пока<br>
кабель выдернут), тогда через некоторый таймаут ошибка будет обнаружена, и<br>
соединение разорвется.</p>
<p>Более того, природа ошибок такова, что надо проверять именно приход <u>ответа</u>
на уровне протокола приложения (уровень 7 в OSI) &mdash; просто посылка данных не<br>
гарантирует корректности. Например, запись в сокет могла быть успешной, данные<br>
были доставлены удаленной машине &mdash; и как раз в этот момент зависло приложение<br>
(а машина работает, данные принимает).</p>
<p>А в SEA Sender наоборот, пинги идут от клиента к серверу. В результате при<br>
обрыве связи в лучшем случае клиент заметит и откроет еще один коннект: будет<br>
два одинаковых пользователя в списке. В худшем же &mdash; и больше, и очередной<br>
реконнект упрется в лимит: все висящие на сервере соединения будут "призраками",<br>
причем на неопределенное время &mdash; сервер ничего не проверяет. Видимо, авторы<br>
просто поленились сделать работу с таймерами, а о сетевой стороне, как всегда,<br>
не подумали...</p>
<p>Не подумали они и о <b>проверках на ошибки</b>. То есть совсем. Даже размеры<br>
команд не проверяются &mdash; по протоколу может требоваться 1 байт, а клиент зашлет<br>
всё 16 Мб, и пускай на сервере память жрется, ага... В коде seasrvkqd есть<br>
предназначенный для этого макрос <tt>CHECK_LENGTH</tt>, который при запуске в<br>
режиме строгих проверок убивает клиента: ведь это может быть и симптомом бага<br>
в клиенте, надо сигнализировать и разобраться...</p>
<p>Не проверяет сервер пустые сообщения &mdash; то есть, нулевого размера. Хотя это<br>
явно или баг, или же кто-то пытается ими флудить.</p>
<p>Кроме того, несмотря на целых два прецедента (с Muzzy и Мишаней) в сервере<br>
нет совершенно никакой защиты от флуда. В seasrvkqd был встроен флуд-контроль,<br>
базирующийся на принципе "пенальти" из IRC. За отправку каждой команды клиенту<br>
начисляются "штрафные" секунды, которые прибавляются к его пенальти-счетчику<br>
(если клиент долго молчал, этот счетчик сначала обновляется до текущего<br>
времени). Допустим, по одной секунде за одну строку в чат, по 2 секунды за<br>
сообщение, и т.д. Если счетчик убегает в будущее (больше текущего времени) на<br>
определенный порог &mdash; значит, клиент флудер, начинаем его тормозить<br>
(обрабатываем команды от него раз в 2 секунды). Если он продолжает флудить и<br>
превышает следующий порог &mdash; клиент убивается совсем. Пороги и штрафы подобраны<br>
таким образом, чтобы нормальный пользователь ничего не заметил. Например, для<br>
сообщений штраф равен двоичному логарифму от длины сообщения. То есть, обычные<br>
сообщения длиной 300 байт пользователь может слать каждые 10 секунд. А длиной<br>
30 Кб &mdash; уже раз в 15 секунд. Будет чаще &mdash; скоро дойдет до порога и будет убит.<br>
Система подтвердила свою эффективность.</p>
<p>Наконец, последняя задача, которая была сделана неудовлетворительно &mdash; это<br>
<b>управление сервером</b>. Оригинальный сервер содержал код, который проверял<br>
каждое отправляемое сообщение. Если оно исходило от пользователя с именем<br>
'<tt>#Kpot#</tt>' и имело специальный формат, то оно не отправлялось никому,<br>
а служило управляющей командой серверу. Их было две: одна в формате<br>
'<tt><b>123.213.231.222</tt>' рассылала всем клиентам команду протокола #13<br>
&laquo;сменить в настройках адрес альтернативного сервера на IP-адрес<br>
123.213.231.222&raquo;. Другая, в формате '</b><tt>|123.213.231.22|</tt>'<br>
называлась "ban", но означала просто &laquo;убить всех клиентов с IP-адреса<br>
123.213.231.22&raquo;.</p>
<p>Чем плох такой подход? Во-первых, пользователи были даже не в курсе, что им<br>
могли что-то поменять. Администрация сети знала о наличии такой возможности<br>
(хотя без подробностей), и это было одним из аргументов по безопасности &mdash; кто<br>
знает, какое еще управление клиентскими машинами туда встроено?..</p>
<p>Во-вторых, не было никакой аутентификации &mdash; <b>любой</b> злонамеренный<br>
пользователь мог подключиться от этого имени и послать команду (и теоретически<br>
потом дождаться на своём альтернативном сервере, использовать дыру в клиенте и<br>
получить полный контроль над машинами). Да, клиент не давал ввести такое имя,<br>
но кто мешает хакеру сделать свой мини-клиент...</p>
<p>В-третьих, сервер был вынужден обрабатывать текст сообщений, вместо<br>
какого-нибудь стандартного средства управления.</p>
<p>Поэтому в seasrvkqd такое управление не было реализовано совсем &mdash; вместо<br>
него было сделано своё, средствами Unix, доступное только администратору<br>
сервера. И при том более гибкое: есть настоящие баны (после флуда, например),<br>
можно задавать им таймаут, можно разбанивать, можно менять URL архива, можно<br>
управлять процессом архивера, включать дебаг...</p>
<p>Впрочем, в этом проекте и протоколе, чтоб работало, хоть что-нибудь должно<br>
быть сделано через анальный порт. Управление в seasrvkqd &mdash; довольно причудливая<br>
комбинация из сигналов и чтения симлинка, выворачивающая привыкшему к типичным<br>
средствам админу мозги набекрень. Просто по приколу ;)</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h3>Возможные улучшения</h3></a>
<p>Внимательный читатель здесь заметит, что протокол, как бы он ни был плох,<br>
всё же содержит в себе возможности расширения. Код под контролем, что-то можно<br>
и поправить, нельзя же всё о плохом да о плохом. Ведь, как известно,<br>
&laquo;критикуя &mdash; предлагай&raquo;. Действительно, профессионал &mdash; он на<br>
то и профессионал, чтобы уметь и &laquo;из говна конфетку сделать&raquo;. В<br>
конце концов, &laquo;...разгребание за нубами и исправление последствий<br>
карусельного метода разработки студентами своих глючных поделий &mdash; это<br>
весьма большой сегмент айтишного рынка на данный момент&raquo;.</p>
<p>И такая возможность была найдена. Было обнаружено, что как штатный клиент,<br>
так и Blastcore всех версий игнорирует ту часть сообщения, что идет после<br>
встречающегося в сообщении двоичного нуля '\0' &mdash; в Си это конец строки<br>
(Blastcore же грузит текст как есть в написанный на Си системный контрол). Это<br>
позволяет передавать после двоичного нуля (называемого также ASCIIZ)<br>
расширенную информацию, которая будет проигнорирована старыми версиями.<br>
Архивер был модифицирован, чтобы вести себя аналогично старой версии.</p>
<p>Далее был использован тот факт, что под поле длины команды отведено 3 байта.<br>
Таким образом, в сообщении становится возможным передавать файлы и<br>
форматированный в RTF текст, если сумма их не превышает 16 мегабайт. То есть,<br>
сначала пишется просто текстовая версия, для старых клиентов, потом &mdash; её версия<br>
с форматированием и приложенный файл. Старые версии проигнорируют кусок, новые<br>
поймут.</p>
<p>Но в обратную сторону, от сервера к клиенту, поля длины в 3 байта нет.<br>
Пришлось этот третий байт "располовинить" и воткнуть в старшую часть каждого<br>
из байтов флага печатников &mdash; потому что оба младших уже были заняты. Сервер<br>
уже поддерживает это изменение протокола, клиент (на начало октября 2010)<br>
пока еще нет (версия 0.4 уже умеет принимать форматированный текст до 64 Кб,<br>
но не может сам отправлять). Ну и можно видеть, что, хотя задача решена,<br>
протокол превращается в сплошное нагромождение костылей и подпорок...</p>
<p>Тут надо сказать, что это &mdash; наиболее востребованное пользователями. Да,<br>
теоретически там еще 240 номеров команд не занято в протоколе. Но старые<br>
клиенты их не знают, надо обрабатывать на сервере. И в новых со старыми иметь<br>
совместимость, попутно в новых командах для более серьезных фич (группы,<br>
регистрация и т.д.) фактически изобретая еще один протокол. А раз по объему<br>
кода получится как новый протокол, то лучше и сделать полностью новый<br>
протокол, сделав шлюз к текущему. Если в случае шлюза TCPSender&lt;-&gt;SEA<br>
Sender еще можно было спорить, что старые сканируют новых, одним сервером не<br>
получится всё (но и это решаемо), то здесь такой проблемы не стоит. В новый<br>
сервер sesrvkqd уже даже встроена рудиментарная поддержка соединения со шлюзом...</p>
<p>Тем более, что и код BlastCore далеко не идеален. Но пока что &mdash; умеем<br>
выжимать насущное из того, что есть сейчас. Будущее, быть может, будет потом.<br>
В следующем разделе.</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h2>Каким могло бы быть будущее</h2>
<h3>TheSender</h3></a>
<p>Как уже упоминалось <a href='#seasunset'>ранее</a>, в 2006 году Вадим<br>
Гончаров (nuclight) писал свой сендер. В <a href='#seashit'>предыдущем разделе</a>
была показана важность проектирования и разработки хорошего протокола, поэтому<br>
начал он именно с изучения опыта предшественников, альтернатив, и сначала<br>
была написана<br>
<a href='/~vadim/sender/thsproto.txt'>спецификация протокола TheSender</a>
(рабочее название проекта). Написана она в стиле<br>
<a href='http://www.rfc-editor.org/'>RFC</a>, официальных документов и<br>
стандартов Internet, с обоснованиями и выкладками, а потому несколько<br>
тяжеловесным языком.</p>
<p>Что позволял этот протокол, сравнительно с предшественниками? Среди много<br>
другого, были, например, такие возможности:</p>
<ul>
<li>Регистрация пользователей: ID выдается один раз (как UIN в аське), а не<br>
случаен при каждом входе; аутентификация "по-взрослому" без передачи пароля по<br>
сети в открытом виде; становится возможным вносить "контакты" в "адресные<br>
книги", и т.д.</li>
<li>Контроль над группой у её хозяев: можно банить, разрешать только чтение,<br>
но не посылку сообщений в группу, настраивать исключения, и т.д.</li>
<li>Наличие многих групп пользователей, пользователи могут присоединяться и<br>
покидать их по своему желанию.</li>
<li>Сообщения хранятся на сервере: только что включившийся пользователь<br>
может запросить с сервера как сообщения себе в приват за время отсутствия (так<br>
делает и ICQ), так и групповые сообщения &mdash; замена отдельного web-архива.</li>
<li>Сообщения имеют идентификаторы, в том числе, ответом на какое другое<br>
сообщение является текущее. Так можно строить "деревья" ответов и фильтровать<br>
неинтересные пользователю "ветки" разговоров.</li>
<li>У сообщений есть приоритеты, пользователь может фильтровать те сообщения,<br>
что не хочет видеть; администрация сети может рассылать "аварийные" оповещения<br>
особой важности.</li>
<li>Некоторые сообщения могут быть "объявлениями" и висеть отдельно, до<br>
истечения их срока жизни &mdash; сейчас пользователям приходится регулярно повторять<br>
сообщения типа &laquo;продам ...&raquo;.</li>
<li>У пользователя может быть много статусов, не только away, но и другие из<br>
ICQ (включая невидимость), плюс возможность указать собственный статус<br>
текстом.</li>
<li>В аварийной ситуации клиенты в одной подсети могут продолжить работу без<br>
сервера (в случае SEA Sender и работ в серверной, пользователи при наличии<br>
сети остаются без связи, хотя именно в этом время она как раз нужнее).</li>
<li>Новый клиент может автоматически настраиваться на находящийся рядом<br>
сервер и регистрироваться на нем (так же, как Windows автоматически получает<br>
IP-адрес). Все остальные сендеры требуют указания как минимум адреса сервера<br>
в настройках.</li>
<li>Проверки на ошибки, в частности, в командах протокола есть сигнатура, при<br>
её несовпадении делается вывод о рассинхронизации клиента и сервера, вместо<br>
возникновения <a href='#seabugs'>причудливых эффектов</a>.</li>
<li>Указание кодировки текста &mdash; актуально для пользователей Unix-систем.</li>
<li>Запросы подтверждения о доставке и прочтении сообщения получателем.</li>
<li>Поддержка вложений файлов в сообщения, не только передача напрямую</li>
<li>Экономный формат: передаются только те данные, которые обновились.</li>
<li>Поддержка ников в дополнение к имени пользователя и машины (настраиваемое<br>
отображение в списке) и другие атрибуты пользователя и сообщений.</li>
<li>Поддержка форматирования сообщений (и в чате тоже) в каком угодно виде:<br>
RTF, HTML, и т.д.</li>
<li>И, конечно же, <b>расширяемость</b> &mdash; даже необходимые чат и передача<br>
файлов были сделаны как "стандартные" расширения, а были идеи и организовать<br>
запрос файлов с человека, аналог P2P, автообновления, групповой чат и др.</li>
</ul>
<p>Спецификация была почти закончена в октябре 2006 &mdash; оставались только неважные<br>
для первоначальной реализации разделы вроде передачи файлов и кодировок. Затем<br>
менее чем за месяц был написан сервер под Unix, 120 Кб (4800 строк) на чистом<br>
Си, использовавший для хранения сообщений и информации о пользователях<br>
BerkeleyDB. Но тестировать сервер не на чем, поэтому надо написать клиент, вот<br>
он-то, как уже описывалось ранее, и не дожил до своего релиза, а вместе с ним<br>
и вся система.</p>
<p>Вот так выглядел прототип:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/thsender-main.png' />"<br>
width="584" height="430" align="center" alt="" title=""></a>
<p>Можно заметить, что стиль цитирования такой же, как в e-mail (в дальнейшем<br>
планировалось выделение цветом вместо разделителей -==-==- SEA Sender). На<br>
части панели инструментов есть кнопка перехода к родительскому сообщению (то,<br>
ответ на которое сейчас показывается) и кнопка отмены случайно удаленного (при<br>
необходимости запросит с сервера) &mdash; решение проблемы "кто мне сейчас что<br>
посылал, повторите, случайно удалил / сендер вылетел".</p>
<p>Далее идут кнопки-фильтры: из всего набора сообщений можно показать только<br>
приватные. Или только групповые. Или только объявления... хотя для них<br>
по-хорошему нужен отдельный интерфейс, но это позже &mdash; вообще, еще одна из<br>
ошибок разработчиков заключается в том, что <b>пользователь не любит непривычного,<br>
например, резкой смены интерфейса</b>. А если в этой группе кнопок не была<br>
нажата ни одна &mdash; показывались все сообщения, как и во всех прежних сендерах:</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/thsender-main-combo.png' />"<br>
width="584" height="430" align="center" alt="" title=""></a>
<p>Показанные приоритеты, на самом деле, не являются чем-то, что устанавливал<br>
только отправитель: можно определить свои собственные фильтры, воспользовавшись<br>
так называемым <i>скорингом</i> &mdash; системе фильтров, присваивающих сообщению<br>
оценку (score). Например, сообщения от юзера "Весёлый<a href='FLOODER.md'>FLOODER</a>" получают оценку<br>
минус 10, сообщения со словом "внешка" &mdash; плюс 20 (или +100 для "сиськи"...).<br>
Тогда может быть настроена, что сообщениям с отрицательной оценкой присваивать<br>
низкий приоритет и автоматически проматывать их (а то и вообще не показывать).<br>
Но если Весёлый<a href='FLOODER.md'>FLOODER</a> напишет что-то о внешке, в сумме сообщение получит +10<br>
и таки будет показано. Это и есть правильное решение проблемы "кто печатает?"<br>
вместо выделения отдельной группы (сами печатники, понятно, установят плюсовую<br>
оценку).</p>
<p>Кроме создания фильтров (в том числе и динамических, т.е. на лету, например,<br>
для ответов на какое-то одно сообщение) и сохранения вложенного файла, можно<br>
выставить и свой статус (в том числе описать его словами):</p>
<a><img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/thsender-main-msgstatus.png' />"<br>
width="584" height="430" align="center" alt="" title=""></a>
<p>Выше уже было видно, что у пользователей в списке соответственно меняются<br>
значки. Предполагалось пойти еще дальше. Так, фильтрацию сообщений по фразам<br>
(без оценок, просто показ/не показ) планировал еще Александров в TCPSender. Он<br>
же предполагал сделать и отображение списка пользователей в виде дерева, а еще<br>
сделать настраиваемый вид юзера в списке. То есть, задается формат типа<br>
<tt>'%1?{ [%2]}:{%3?{ [%2]}:{%2}}, %6'</tt>, где %1 &mdash; имя пользователя, %2 имя<br>
машины, и т.д., и каждый сможет видеть так, как хочет. И сортировать список по<br>
любому из полей...</p>
<p>Многое можно было бы еще сделать. Но... избежав ошибок предшественников,<br>
nuclight допустил свою: <b>следует соразмерять планируемое к первой версии с<br>
рынком и имеющимися ресурсами на реализацию</b>. Все предыдущие сендеры, как<br>
уже говорилось, делались командой минимум из двух человек. Здесь же на задачу<br>
бОльшего размера &mdash; был только один. Каким бы он ни был хорошим программистом,<br>
объем задач есть объем задач. TheSender, глядя на присутствие в сети двух<br>
общежитий, изначально рассчитывался на охват всего студгородка (в дальнейшем<br>
планировалось сделать сеть связанных друг с другом серверов, как в IRC), что<br>
еще более увеличивало объем работ.</p>
<p>В случае конкуренции продуктов на рынке ситуация еще более жесткая. Да,<br>
разрабатываемая система может быть на голову выше конкурентов, и переманит к<br>
себе львиную долю пользователей, как только выйдет, но если Вы разоритесь до<br>
того, как успеете её сделать...</p>
<p>В общаге, конечно, не рынок и не кредиты на разработку &mdash; но суть остается<br>
та же, просто вступают в дело аналогичные факторы-заменители (типа "сессия"<br>
или "отчислился").</p>
<p>Позже, в принципе, можно было бы вернуться к проекту, но со временем стали<br>
ясны некоторые недоработки &mdash; многое сейчас в протоколе следовало бы изменить,<br>
что-то выкинуть, что-то добавить.</p>
<a></a>
<p>И не только в протоколе. Позже было выяснено, что многие пользователи не<br>
считают сендер удобным, в частности, из-за необходимости "перемотки" сообщений<br>
туда-сюда. Среди вариантов решения возникла идея сделать интерфейс похожим на<br>
организацию блогов или IM-клиентов. Например, один из плагинов популярного<br>
клиента Miranda имеет вот такой вид:</p>
<img src="<img src='http://seasrvkq.googlecode.com/svn/wiki/imgshist/miranda-historyplusplus.jpg' />"<br>
width="762" height="605" align="center" alt="" title=""><br>
<p>Это именно что интерфейс для отображения многострочных сообщений &mdash; границы<br>
между ними четко видны, он останется сендером, а не чатом. Впрочем, это лишь<br>
идея, над которой еще следует думать, опрашивать народ, и т.д.</p>
<p>Если найдется команда энтузиастов, которая решит, что им это по силам &mdash; то<br>
сендер может получить новое обличие (тем более, что в текущий сервер уже<br>
заложена рудиментарная поддержка шлюзования). Пока же система находится в<br>
состоянии "как-то работает, и ладно", потому что этот результат мог быть<br>
достигнут быстро &mdash; переписать сервер и клиент довольно примитивного SEA было<br>
проще и быстрее, чем создать новую качественную систему. Так и живем с синицей<br>
в руках.</p>
<p>До тех пор, пока кто-то не придет и не предложит лучшее.</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<a><h3>Предложение Крота</h3></a>
<p>В конце октября 2009 года #Kpot#<br>
<a href='http://seasrvkq.googlecode.com/svn/wiki/Kpot_New_sender20091028.doc'>предложил</a>
новую архитектуру сендера:<br>
клиент на .NET, опрашивающий php/mysql-сервер по HTTP. Оно не было воплощено в<br>
жизнь, и к лучшему, потому что описание предложенного вызвало, мягко говоря,<br>
недоумение &mdash; это нечто еще более худшее, чем SEA Sender. Стоит процитировать<br>
и разобрать наиболее яркие моменты:</p>
<blockquote>Поверьте, достаточно муторно работать с байтами (к тому же, если<br>
отправитель послал n байт, получателю могут прийти все n разом, а могут и по<br>
частям).</blockquote>
<p>Да, могут, такова природа TCP. Но ничего муторного в этом нет: это просто<br>
надо учитывать в соответствующих циклах приема/отправки. В конце концов, это<br>
делает большинство Internet-приложений (которые не Web).</p>
<blockquote>Плюс, нужно следить за разрывами соединения и делать реконнект.<br>
Вторая проблема &mdash; самописный сервер. Это те же сокеты, только в большом<br>
количестве, и работающие параллельно. Я обнаружил ещё один "прикол" сокетов &mdash;<br>
иногда соединение повисает на несколько часов. При этом не срабатывает<br>
коннект-таймаут, и исключения тоже не вылетает.</blockquote>
<p>А это, фактически, расписка в собственном неумении программировать сетевые<br>
приложения. Хотя скорее, конечно, это нежелание разбираться с багами (и методами<br>
их обхода) на той конкретной платформе, где ведется работа. В конце концов,<br>
успешно работающие сервера без таких проблем есть на всех платформах, а на<br>
некоторых они прекрасно обрабатывают десятки тысяч клиентов одновременно (как<br>
"самописный" web-сервер nginx, например).</p>
<blockquote>В общем, идея новой архитектуры &mdash; отказ от собственного сервера,<br>
и работа с сетью на высоком уровне &mdash; пусть всю мелкую работу сделают за<br>
нас.</blockquote>
<p>Звучит как "мы столкнулись с проблемами и не осилили их". Нет, переложение<br>
работы на нижележащие слои действительно было бы практичным, оправданным<br>
решением &mdash; если бы давало преимущества. Но как видно будет далее, предлагаемое<br>
решение на самом деле хуже.</p>
<p>Затем идет несколько хороших предложений: постоянные ID и регистрация<br>
пользователей, глобальная таблица всех изменений. Но потом:</p>
<blockquote>Далее, каждые 10 секунд клиент обращается к ping.php и узнаёт об<br>
изменениях на сервере.</blockquote>
<p>Кхм... Оставим в стороне воспоминания о web-чатах конца 90-х. Предположим,<br>
в таблице уже висят 50 тысяч изменений. Тут приходит злой клиент и запрашивает<br>
lastchange=1. На что сервер БД радостно перебирает ВСЮ историю. А еще клиент<br>
может делать такие запросы гораздо чаще, чем раз в 10 секунд.</p>
<p>Впрочем, фиг с ними, со злоумышленниками. Здесь совершенно штатные клиенты<br>
будут создавать постоянную нагрузку на сервер даже тогда, когда ничего не<br>
происходит! Если 200 клиентов онлайн &mdash; это 20 запросов в секунду при полной<br>
тишине, если 300 &mdash; уже 30, и еще больше, если кто-то начнет слать сообщения.<br>
Которые, кстати, остальной группе будут доходить с задержкой до 10 секунд.<br>
Средство IM, то есть обмена мгновенными сообщениями, что вы хотите.</p>
<blockquote>Чтобы не повторять код, список пользователей не передаётся в<br>
connect.php, он передастся при ближайшем обращении к ping.php.</blockquote>
<p>Ну да, увеличим нагрузку на сервер на еще один запрос. Кстати, в этом<br>
описании еще и <i>все</i> пользователи сети будут получать <i>полный</i> список<br>
пользователей при коннекте нового, вместо просто события. А еще неизвестное<br>
время дисконнекта: давно не пинговавших онлайновых придется чистить по таймеру,<br>
что возвращает нас во времена даже не SEA Sender, а TCPSender &mdash; когда юзер мог<br>
висеть в списке много минут, будучи уже в оффлайне...</p>
<p><a href='#toc'>назад к оглавлению</a></p>
<br><p> <b></p></b><br>
<p>На том история &mdash; то, что было в прошлом &mdash; заканчивается. Дальше<br>
начинается настоящее &mdash; и пусть тот, кто учел ошибки прошлого, сотворит<br>
нечто лучшее в будущем. Респект всем тем, кто осилил прочитать весь текст до<br>
конца :-)</p>
<br>
<br>
<hr width="26%" align="right"><br>
<br>
<br>
<p>(c) nuclight, сентябрь 2009 &ndash; октябрь 2010</p>